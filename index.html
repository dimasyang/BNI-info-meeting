<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>æ ¸å¿ƒåœ˜æˆå“¡ï¼10/01~11/05ï¼šå‡ºå¸­/é²åˆ°/ç¼ºå¸­ï¼‹ä¾†è³“ï¼ˆå¯è¼¸å…¥ï¼‰ï¼‹ä¸€å°ä¸€ï¼‹çŸ©é™£ï¼‹äº®ç‡ˆ</title>
<style>
  :root{ --bg:#111; --card:#1b1b1b; --muted:#9aa0a6; --text:#e8eaed; --accent:#caaa00; --border:#2b2b2b; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
  button{background:#222;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{background:#262626}
  .tag{padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 20px #00000040;overflow:hidden}
  .table-wrap{overflow:auto;border-top:1px solid var(--border)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:linear-gradient(180deg,#1f1f1f,#1a1a1a);z-index:3}
  th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:center;white-space:nowrap}
  tbody tr:hover{background:#1c1c1c}
  th:first-child,td:first-child{position:sticky;left:0;background:inherit;z-index:2}
  th:nth-child(2),td:nth-child(2){position:sticky;left:60px;background:inherit;z-index:2}
  th:nth-child(3),td:nth-child(3){position:sticky;left:200px;background:inherit;z-index:2}
  th:nth-child(1){min-width:60px}
  th:nth-child(2){min-width:140px}
  th:nth-child(3){min-width:240px}
  .date-head{min-width:120px}
  .date-chip{display:inline-block;background:var(--accent);color:#000;padding:4px 10px;border-radius:8px;font-weight:600}
  .cell-wrap{display:flex;flex-direction:column;align-items:center;gap:6px}
  .status{display:inline-grid;place-items:center;width:32px;height:32px;border-radius:999px;border:1px solid var(--border);background:#111;cursor:pointer;user-select:none;position:relative}
  .status[aria-label="ğŸŸ¢"]{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.5)}
  .status[aria-label="ğŸŸ¡"]{background:rgba(202,138,4,.12);border-color:rgba(202,138,4,.5)}
  .status[aria-label="ğŸ”´"]{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.5)}
  /* ä¸€å°ä¸€äº®ç‡ˆï¼ˆæœ‰é…å°å°±äº®è—ç‡ˆï¼‰ */
  .status .o2o-dot{position:absolute;left:-6px;top:-6px;width:10px;height:10px;border-radius:50%;background:#3b82f6;border:1px solid var(--border);display:none}
  .status.o2o{background:rgba(59,130,246,.12);box-shadow:0 0 0 2px rgba(59,130,246,.35)}
  .status.o2o .o2o-dot{display:block}
  /* ä¾†è³“æ•¸å­—æ§åˆ¶ */
  .guest-wrap{display:flex;align-items:center;gap:4px}
  .guest-step,.guest-zero{font-size:11px;line-height:1;padding:3px 6px;border-radius:8px;border:1px solid var(--border);background:#222;color:#ddd;cursor:pointer}
  .guest-input{width:40px;text-align:center;background:#121212;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:3px 4px}
  /* é…å°èˆ‡çŸ©é™£ */
  .pair-btn{font-size:11px;line-height:1;padding:3px 6px;border-radius:8px;border:1px solid var(--border);background:#222;color:#ddd;cursor:pointer}
  .pair-btn:hover{background:#2a2a2a}
  .o2o-pill{font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:8px;background:#121212;color:#ccc}
  .totals{font-size:12px;display:flex;gap:8px;justify-content:center;color:var(--muted)}
  .dot{font-size:12px}
  .footer{color:var(--muted);padding:12px 16px}
  .search{margin-left:auto}
  input[type="search"]{background:#121212;color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;min-width:220px}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  dialog{color:var(--text)}
  /* çŸ©é™£æ¨£å¼ */
  .matrix-card h2{font-size:16px;margin:16px}
  #matrixWrap{overflow:auto;border-top:1px solid var(--border)}
  #matrix{border-collapse:separate;border-spacing:0;width:100%}
  #matrix th,#matrix td{border-bottom:1px solid var(--border);border-right:1px solid var(--border);padding:8px 10px;text-align:center;white-space:nowrap}
  #matrix th:first-child,#matrix td:first-child{position:sticky;left:0;background:#171717;z-index:1}
  #matrix thead th{position:sticky;top:0;background:#171717;z-index:2}
  .diag{background:repeating-linear-gradient(45deg,#333 0,#333 4px,#222 4px,#222 8px)}

/* ==== Matrix tidy + RWD-stable (V3.7) ==== */
#matrix-wrap{ overflow-x:auto; }
#matrix{
  table-layout: fixed !important;
  width: max-content !important;
  border-collapse: separate !important;
  border-spacing: 0 !important;
}
#matrix *, #matrix th, #matrix td{ box-sizing: border-box !important; }
#matrix th, #matrix td{
  padding: 8px 10px !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  vertical-align: middle !important;
}
#matrix th:first-child, #matrix td:first-child{
  min-width: 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}
#matrix thead th:not(:first-child), #matrix tbody td:not(:first-child){
  min-width: 72px !important;
  width: 72px !important;
  max-width: 72px !important;
}
/* lights */
#matrix td.lit{ background-color: rgba(59,130,246,0.28) !important; box-shadow: inset 0 0 0 2px rgba(59,130,246,.55) !important; border-color: rgba(59,130,246,.65) !important; font-weight:700; }
#matrix td.diag-self{ background-image: repeating-linear-gradient(135deg, rgba(255,255,255,0.16) 0px, rgba(255,255,255,0.16) 8px, transparent 8px, transparent 16px); background-color: rgba(250,204,21,0.18); box-shadow: inset 0 0 0 1px rgba(250,204,21, .45); position:relative; }
#matrix td.diag-self::after{ content:"â—"; position:absolute; right:6px; top:4px; font-size:12px; opacity:.75; }
#matrix td.diag-self.lit{ background-color: rgba(250,204,21,0.18) !important; box-shadow: inset 0 0 0 1px rgba(250,204,21, .45) !important; border-color: rgba(250,204,21, .45) !important; }

/* === Diagonal full-fill fix (V3.8) === */
#matrix td.diag-self{
  position: relative !important;
  overflow: hidden !important;
  background: none !important; /* we'll paint via ::before to ensure full cover */
}
#matrix td.diag-self::before{
  content: "" !important;
  position: absolute !important;
  inset: 0 !important;
  background-image:
    repeating-linear-gradient(135deg, rgba(255,255,255,0.16) 0px, rgba(255,255,255,0.16) 8px, transparent 8px, transparent 16px),
    linear-gradient(rgba(250, 204, 21, 0.18), rgba(250, 204, 21, 0.18));
  z-index: 0 !important;
  pointer-events: none !important;
}
#matrix td.diag-self::after{
  z-index: 1 !important; /* the â— icon stays above the fill */
}

/* === Bottom-matrix-only light (v3.9) === */
#matrix td.lit{
  background-color: rgba(59,130,246,0.32) !important;
  box-shadow: inset 0 0 0 2px rgba(59,130,246,.6) !important;
  border-color: rgba(59,130,246,.7) !important;
  font-weight: 800;
}
/* ensure header or any other 'lit' elsewhere is unaffected */
:not(#matrix) td.lit, :not(#matrix) div.lit, :not(#matrix) span.lit { all: unset; }


/* === Matrix tidy layout v1 === */
#matrix table{border-collapse:collapse;table-layout:fixed;width:100%;}
#matrix th,#matrix td{border:1px solid #e5e7eb;text-align:center;vertical-align:middle;
  padding:6px 8px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#matrix th{background:#f8fafc;font-weight:600;}
#matrix td{background:#ffffff;}
#matrix td.diag{background:#f3f4f6;}
#matrix td.lit{background:rgba(255,214,102,.28);outline:2px solid rgba(255,184,0,.9);font-weight:700;}
/* fixed cell sizing for neat grid on desktop */
@media(min-width:1024px){
  #matrix th,#matrix td{width:48px;height:38px;}
}
/* make it scrollable on small screens */
#matrix .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch;}
#matrix .scroll-x table{min-width:720px;}



<style>
/* === LightLock v3.2 (overlay only, no pointer-events tweak) === */
#authShield{
  position:fixed; inset:0; z-index:2147483646; /* on top */
  display:flex; align-items:center; justify-content:center;
  background:rgba(255,255,255,.9);
  -webkit-backdrop-filter:saturate(120%) blur(1px);
  backdrop-filter:saturate(120%) blur(1px);
}
#authShield.hidden{display:none;}
#authShield .tap{
  padding:10px 14px; border:1px solid #0f172a; border-radius:9999px;
  background:#fff; font-size:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.12);
}


<style>
/* === LightLock v4 === */
#authShield{position:fixed;inset:0;z-index:2147483646;display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.85);backdrop-filter:saturate(120%) blur(1px);}
#authShield.hidden{display:none;}
#authShield .tap{width:14px;height:14px;border-radius:9999px;border:2px solid #111;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.12);}
</style>

</style>

</style>
</head>
<body>

<style>
#forceApplyBtn{position:fixed;right:12px;top:54px;z-index:99999;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;opacity:.85}
#forceApplyBtn:hover{opacity:1}
</style>
<button id="forceApplyBtn" title="å¼·åˆ¶æŠŠæœ€è¿‘ä¸€æ¬¡é›²ç«¯è³‡æ–™å¥—åˆ°ç•«é¢">å¼·åˆ¶å¥—ç”¨é›²ç«¯</button>



<style>
/* === Toast UI (non-blocking) === */
#__toastRoot{position:fixed;right:16px;top:16px;z-index:2147483645;display:flex;flex-direction:column;gap:8px}
.toast{background:#111827;color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.2);opacity:.98}
.toast.ok{background:#065f46}.toast.warn{background:#92400e}.toast.err{background:#7f1d1d}
.toast small{opacity:.9}
</style>
<div id="__toastRoot" aria-live="polite" aria-atomic="true"></div>
<script>
window.showToast = function(msg, type){
  try{
    const root = document.getElementById('__toastRoot'); if(!root) return;
    const el = document.createElement('div');
    el.className = 'toast ' + (type||'ok');
    el.innerHTML = msg;
    root.appendChild(el);
    setTimeout(()=>{ el.style.transition='opacity .25s'; el.style.opacity='0'; setTimeout(()=>el.remove(), 300); }, 2200);
  }catch(e){}
};
</script>



<style>
/* === Edit Gate UI === */
#editBar{position:fixed; right:12px; top:12px; z-index:99999; display:flex; gap:8px;}
#editBar button{padding:6px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; font-size:12px; cursor:pointer;}
#editBar .on{border-color:#0ea5e9; box-shadow:0 0 0 2px rgba(14,165,233,.15);}
#editHint{position:fixed; right:12px; top:46px; z-index:99998; font-size:12px; color:#6b7280;}
</style>
<div id="editBar" aria-hidden="false">
  <button id="editToggleBtn" title="åˆ‡æ›ç·¨è¼¯">ç·¨è¼¯</button>
</div>



</div>
<div class="wrap">
<h1>æ ¸å¿ƒåœ˜æˆå“¡ï¼10/01 ~ 11/05ï¼ˆğŸŸ¢å‡ºå¸­ï½œğŸŸ¡é²åˆ°ï½œğŸ”´ç¼ºå¸­ï¼‰</h1>
<div class="toolbar">
<span class="tag">æ—¥æœŸï¼š10/01ã€10/08ã€10/15ã€10/22ã€10/29ã€11/05ï¼ˆç„¡è«‹å‡åˆ¶åº¦ï¼‰</span>
<span class="tag">ğŸ‘¥ ä¾†è³“ï¼š- / + / ç›´æ¥è¼¸å…¥ / 0 æ­¸é›¶</span>
<span class="tag">ğŸ¤ ä¸€å°ä¸€ï¼šæŒ‰ã€Œé…å°ã€å‹¾é¸å°è±¡ï¼Œæ•¸å­—è‡ªå‹•å¸¶å…¥ï¼Œæ ¼å­æœƒäº®è—ç‡ˆ</span>
<button id="importBtn">åŒ¯å…¥æˆå“¡</button>
<button id="saveBtn">å„²å­˜</button>
<button id="loadBtn">è®€å–</button>
<button id="clearBtn">æ¸…ç©º</button>
<button id="csvBtn">åŒ¯å‡ºCSV</button>
<button id="printBtn">åˆ—å°</button>
<input class="search" id="q" placeholder="å¿«é€Ÿæœå°‹å§“å/å°ˆæ¥­åˆ¥â€¦" type="search"/>
</div>
<div class="card">
<div class="table-wrap">
<table id="grid">
<thead>
<tr>
<th>#</th>
<th>å§“å</th>
<th>å°ˆæ¥­åˆ¥</th>
<th class="date-head"><span class="date-chip">10/01</span><div class="totals" data-date="2025-10-01"></div></th>
<th class="date-head"><span class="date-chip">10/08</span><div class="totals" data-date="2025-10-08"></div></th>
<th class="date-head"><span class="date-chip">10/15</span><div class="totals" data-date="2025-10-15"></div></th>
<th class="date-head"><span class="date-chip">10/22</span><div class="totals" data-date="2025-10-22"></div></th>
<th class="date-head"><span class="date-chip">10/29</span><div class="totals" data-date="2025-10-29"></div></th>
<th class="date-head"><span class="date-chip">11/05</span><div class="totals" data-date="2025-11-05"></div></th>
<th>å‡ºå¸­ç‡</th>
<th>ä¾†è³“ç¸½æ•¸</th>
<th>å¸¶ä¾†è³“æ¯”ç‡</th>
<th>ä¸€å°ä¸€æ¬¡æ•¸</th>
<th>ä¸€å°ä¸€æ¯”ç‡</th>
<th>ç¸½é«”ç¸¾æ•ˆ</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
<div class="footer">é»åœ“é»åˆ‡æ›ï¼šğŸŸ¢ â†’ ğŸŸ¡ â†’ ğŸ”´ â†’ ç©ºç™½ã€‚æ¯æ ¼å¯ç›´æ¥è¼¸å…¥ä¾†è³“æ•¸ï¼›æŒ‰ã€Œé…å°ã€å‹¾é¸å°è±¡å¾Œï¼Œä¸‹æ–¹çŸ©é™£æœƒè‡ªå‹•æ›´æ–°ã€‚è³‡æ–™ä¿å­˜åœ¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚</div>
</div>
<!-- ä¸€å°ä¸€é…å°çŸ©é™£ï¼ˆå¾€ä¸‹æ‹‰ï¼‰ -->
<div class="card matrix-card" id="o2oMatrixCard" style="margin-top:16px;">
<h2>ä¸€å°ä¸€é…å°çŸ©é™£ï¼ˆéš¨ä¸Šæ–¹ã€Œé…å°ã€è¨­å®šè‡ªå‹•æ›´æ–°ï¼‰</h2>
<div id="matrixWrap"><div id="matrix-wrap"><table id="matrix"></table></div></div>
<div class="footer" style="color:#9aa0a6;">æ–œç·š=æœ¬äººï¼›æ•¸å­—=æ­¤æœŸé–“ä¸€å°ä¸€æ¬¡æ•¸ï¼ˆåŒä¸€å¤©åŒä¸€çµ„åªç®—ä¸€æ¬¡ï¼Œä¸é‡è¤‡ï¼‰ã€‚</div>
</div>
<div class="hint">CSV å«çµ±è¨ˆæ¬„ï¼‹ä¸€å°ä¸€æ¬„ä½ï¼›å¯ç›´æ¥è²¼åˆ° Excel/Google è©¦ç®—è¡¨ã€‚</div>
</div>
<!-- æˆå“¡åŒ¯å…¥å°è©±æ¡† -->
<dialog id="importDialog">
<form method="dialog" style="min-width:min(720px,90vw);background:#1b1b1b;border:1px solid var(--border);border-radius:12px;padding:16px;">
<h3 style="margin:0 0 8px;">åŒ¯å…¥æˆå“¡ï¼ˆæ¯åˆ—ï¼šç·¨è™Ÿ,å§“å,å°ˆæ¥­åˆ¥ï¼‰</h3>
<p style="color:#9aa0a6;">å¯è²¼ Excel è½‰å­˜çš„ CSVï¼Œæˆ–ä½¿ç”¨ TAB/é€—è™Ÿåˆ†éš”ã€‚åŒ¯å…¥å¾Œæœƒè¦†è“‹ç¾æœ‰åå–®ä¸¦é‡å»ºè¡¨æ ¼ã€‚</p>
<textarea id="importText" rows="10" style="width:100%;background:#121212;color:#eee;border:1px solid var(--border);border-radius:8px;padding:8px;white-space:pre;"></textarea>
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
<button value="cancel">å–æ¶ˆ</button>
<button id="doImport" value="default">åŒ¯å…¥</button>
</div>
</form>
</dialog>
<!-- ä¸€å°ä¸€é…å°å°è±¡é¸æ“‡ -->
<dialog id="pairDialog">
<form method="dialog" style="min-width:min(540px,90vw);background:#1b1b1b;border:1px solid var(--border);border-radius:12px;padding:16px;">
<h3 id="pairTitle" style="margin:0 0 8px;">é¸æ“‡ä¸€å°ä¸€å°è±¡</h3>
<div id="pairList" style="max-height:50vh;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px;background:#121212"></div>
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
<button value="cancel">å–æ¶ˆ</button>
<button id="pairOK" value="default">ç¢ºå®š</button>
</div>
</form>
</dialog>
<script>
// === åŸºæœ¬è¨­å®š ===
const DATES = ["10/01","10/08","10/15","10/22","10/29","11/05"]; // é¡¯ç¤º
const DATE_KEYS = ["2025-10-01","2025-10-08","2025-10-15","2025-10-22","2025-10-29","2025-11-05"]; // å­˜æª”
const STORAGE_KEY = "core-team-traffic-2025-10";
const MEMBERS_KEY = "core-team-members-2025-10";

let MEMBERS = [
  { id:1,  name:"å¾åœ‹è¯", profession:"ä¸­è—¥åŒ…è£è¨­å‚™è²·è³£æ¥­" },
  { id:2,  name:"å³å† ç’‹", profession:"ç†è²¡è¦åŠƒä¿éšªæ¥­" },
  { id:3,  name:"é˜å§µç¾š", profession:"åœŸåœ°é–‹ç™¼æ¥­" },
  { id:4,  name:"æå®‡æ™´", profession:"å¸‚èª¿æ¥­" },
  { id:5,  name:"é™³æ¸…ç‰", profession:"èŒ¶è£½å“æ‰¹ç™¼é›¶å”®" },
  { id:6,  name:"æ—ä½‘å„’", profession:"è¸ç‰›é¤Šæ®–è²·è³£æ¥­" },
  { id:7,  name:"æ—å½¥å®", profession:"ç±³ç³§å•†" },
  { id:8,  name:"é™³å»ºå®", profession:"è»ŸåŒ…è£å®¢è£½åŒ–å·¥å» " },
  { id:9,  name:"æ±Ÿèª ä»²", profession:"æµ·è‹”æ‰¹ç™¼é›¶å”®" },
  { id:10, name:"ææœµå«»", profession:"å’–å•¡çƒ˜è±†æ¥­" },
  { id:11, name:"é¾æ˜†ç¿°", profession:"æ±½è»Šéè†œæ¥­" },
  { id:12, name:"å¾å­è¡¡", profession:"æ²¹å“å“ç‰Œå•†" },
  { id:13, name:"å³å…¸è“‰", profession:"æ°‘äº‹è¨´è¨Ÿå¾‹å¸«" },
];

const tbody = document.getElementById('tbody');

// ä¾†è³“æ§åˆ¶ï¼ˆæ•¸å­—ï¼‰
function guestControls(){
  const wrap = document.createElement('div'); wrap.className = 'guest-wrap';
  const minus = document.createElement('button'); minus.type='button'; minus.className='guest-step'; minus.textContent='-';
  const input = document.createElement('input'); input.type='number'; input.className='guest-input'; input.min='0'; input.max='99'; input.value='0';
  const plus = document.createElement('button'); plus.type='button'; plus.className='guest-step'; plus.textContent='+';
  const zero = document.createElement('button'); zero.type='button'; zero.className='guest-zero'; zero.textContent='0'; zero.title='æ­¸é›¶';
  const clamp = ()=>{ let v=parseInt(input.value||'0'); if(isNaN(v)||v<0) v=0; if(v>99) v=99; input.value=String(v); };
  minus.addEventListener('click', ()=>{ input.value = String(Math.max(0, (parseInt(input.value||'0')||0)-1)); input.dispatchEvent(new Event('input')); });
  plus.addEventListener('click',  ()=>{ input.value = String(Math.min(99,(parseInt(input.value||'0')||0)+1)); input.dispatchEvent(new Event('input')); });
  zero.addEventListener('click',  ()=>{ input.value = '0'; input.dispatchEvent(new Event('input')); });
  input.addEventListener('input', ()=>{ clamp(); updateTotals(); });
  wrap.append(minus,input,plus,zero);
  return wrap;
}

// ç‹€æ…‹ï¼‹ä¾†è³“ï¼‹ä¸€å°ä¸€ï¼ˆé…å°ï¼‰
function statusCell(dataKey){
  const wrap = document.createElement('div'); wrap.className = 'cell-wrap';
  const btn = document.createElement('button'); btn.className = 'status'; btn.setAttribute('data-date', dataKey); btn.setAttribute('aria-label',''); btn.textContent = ''; btn.title='å·¦éµï¼šå‡ºå¸­/é²åˆ°/ç¼ºå¸­'; btn.addEventListener('click', ()=> cycle(btn));
  // è—è‰²å°ç‡ˆ
  const dot = document.createElement('span'); dot.className='o2o-dot'; btn.appendChild(dot);
  wrap.appendChild(btn);
  // ä¾†è³“
  wrap.appendChild(guestControls());
  // ä¸€å°ä¸€ï¼šé…å°æŒ‰éˆ• + é¡¯ç¤º Pill
  const pill = document.createElement('span'); pill.className='o2o-pill'; pill.textContent='ğŸ¤ 0'; pill.dataset.count='0';
  const pair = document.createElement('button'); pair.type='button'; pair.className='pair-btn'; pair.textContent='é…å°'; pair.dataset.partners='[]';
  pair.addEventListener('click',()=>openPairDialog(btn, pill));
  wrap.append(pill, pair);
  return wrap;
}

function buildTable(){
  tbody.innerHTML='';
  MEMBERS.forEach((m)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${m.id}</td><td>${m.name}</td><td style="text-align:left;white-space:normal">${m.profession}</td>`;
    DATE_KEYS.forEach(k=>{ const td=document.createElement('td'); td.appendChild(statusCell(k)); tr.appendChild(td); });
    // å³å´ 6 æ¬„ä½ä½”ä½
    for(let i=0;i<6;i++){ const td=document.createElement('td'); tr.appendChild(td); }
    tbody.appendChild(tr);
  });
  buildMatrix();
}

const STATES=['','ğŸŸ¢','ğŸŸ¡','ğŸ”´'];
function cycle(btn){ const cur=btn.getAttribute('aria-label')||''; const idx=STATES.indexOf(cur); const nxt=STATES[(idx+1)%STATES.length]; btn.setAttribute('aria-label',nxt); btn.textContent=nxt; updateTotals(); }

// === ä¸€å°ä¸€é…å° ===
const pairDialog=document.getElementById('pairDialog');
const pairList=document.getElementById('pairList');
const pairOK=document.getElementById('pairOK');
const pairTitle=document.getElementById('pairTitle');
let pairCtx=null; // {btn, pill, ri, di}

function openPairDialog(btn, pill){
  const cell = btn.closest('td');
  const tr = cell.closest('tr'); const ri = [...tbody.children].indexOf(tr);
  const di = [...tr.children].indexOf(cell) - 3; // offset by 3 fixed cols
  pairCtx = { btn, pill, ri, di };
  pairTitle.textContent = `${MEMBERS[ri].name}ï¼${DATES[di]} çš„ä¸€å°ä¸€å°è±¡`;
  pairList.innerHTML='';
  MEMBERS.forEach((m,idx)=>{
    if(idx===ri) return;
    const row=document.createElement('label'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 4px';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.value=String(idx);
    row.append(cb, document.createTextNode(`${m.id}. ${m.name}ï½œ${m.profession}`));
    pairList.appendChild(row);
  });
  // å¥—å…¥å·²é¸
  try{
    const partners = JSON.parse(cell.querySelector('.pair-btn').dataset.partners||'[]');
    [...pairList.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{ cb.checked = partners.includes(parseInt(cb.value)); });
  }catch(e){}
  pairDialog.showModal();
}

pairOK?.addEventListener('click',()=>{
  if(!pairCtx) return;
  const {btn,pill,ri,di} = pairCtx;
  const cell = btn.closest('td');
  const chosen = [...pairList.querySelectorAll('input[type="checkbox"]')].filter(i=>i.checked).map(i=>parseInt(i.value));
  const pairBtn = cell.querySelector('.pair-btn'); pairBtn.dataset.partners = JSON.stringify(chosen);
  // æ›´æ–° pill é¡¯ç¤ºèˆ‡è—ç‡ˆ
  pill.dataset.count = String(chosen.length);
  pill.textContent = `ğŸ¤ ${chosen.length}`;
  btn.classList.toggle('o2o', chosen.length>0);
  updateTotals();
});

// === å„²å­˜/è®€å– ===
function snapshot(){
  const rows=[];
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
    const cells=tr.querySelectorAll('td');
    const row={ id: MEMBERS[ri].id };
    DATE_KEYS.forEach((k,di)=>{
      const cell=cells[3+di];
      const b=cell.querySelector('.status');
      const g=cell.querySelector('.guest-input');
      const p=cell.querySelector('.pair-btn');
      const pill=cell.querySelector('.o2o-pill');
      row[k]=b.getAttribute('aria-label')||'';
      row[k+'_g']=parseInt(g?.value||'0')||0;
      try{ row[k+'_p']=JSON.parse(p?.dataset.partners||'[]'); }catch(e){ row[k+'_p']=[]; }
      row[k+'_1on1']=parseInt(pill?.dataset.count||'0')||0; // å†—é¤˜å„²å­˜
    });
    rows.push(row);
  });
  return rows;
}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot())); alert('å·²å„²å­˜åˆ°æœ¬æ©Ÿã€‚'); }

function load(){
  const mraw=localStorage.getItem(MEMBERS_KEY); if(mraw){ try{ MEMBERS=JSON.parse(mraw);}catch(e){} }
  buildTable();
  const raw=localStorage.getItem(STORAGE_KEY); if(!raw){ updateTotals(); return; }
  const rows=JSON.parse(raw);
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
    const cells=tr.querySelectorAll('td');
    DATE_KEYS.forEach((k,di)=>{
      const cell=cells[3+di];
      const b=cell.querySelector('.status');
      const g=cell.querySelector('.guest-input');
      const p=cell.querySelector('.pair-btn');
      const pill=cell.querySelector('.o2o-pill');
      const v=rows[ri]?.[k]||''; b.setAttribute('aria-label',v); b.textContent=v;
      const gval=parseInt(rows[ri]?.[k+'_g'])||0; if(g) g.value=String(gval);
      const partners=Array.isArray(rows[ri]?.[k+'_p'])? rows[ri][k+'_p'] : []; p.dataset.partners = JSON.stringify(partners);
      const n = partners.length>0 ? partners.length : (parseInt(rows[ri]?.[k+'_1on1'])||0);
      pill.dataset.count = String(n); pill.textContent = `ğŸ¤ ${n}`;
      b.classList.toggle('o2o', n>0);
    });
    fillRightSummary(tr,ri);
  });
  updateTotals();
}

function clearAll(){
  if(!confirm('æ¸…ç©ºæ‰€æœ‰æ¨™è¨˜èˆ‡ä¾†è³“/ä¸€å°ä¸€ï¼Ÿï¼ˆåå–®ä¸æœƒè¢«åˆªé™¤ï¼‰')) return;
  localStorage.removeItem(STORAGE_KEY);
  [...document.querySelectorAll('.status')].forEach(b=>{b.setAttribute('aria-label','');b.textContent='';b.classList.remove('o2o');});
  [...document.querySelectorAll('.guest-input')].forEach(i=>{i.value='0'});
  [...document.querySelectorAll('.o2o-pill')].forEach(el=>{el.dataset.count='0'; el.textContent='ğŸ¤ 0';});
  [...document.querySelectorAll('.pair-btn')].forEach(p=>{p.dataset.partners='[]'});
  updateTotals();
}

// === åŒ¯å‡º CSV ===
function exportCSV(){
  const headers=['ç·¨è™Ÿ','å§“å','å°ˆæ¥­åˆ¥',...DATES,'å‡ºå¸­ç‡','ä¾†è³“ç¸½æ•¸','å¸¶ä¾†è³“æ¯”ç‡','ä¸€å°ä¸€æ¬¡æ•¸','ä¸€å°ä¸€æ¯”ç‡','ç¸½é«”ç¸¾æ•ˆ'];
  const lines=[headers.join(',')];
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
    const base=[MEMBERS[ri].id, MEMBERS[ri].name, MEMBERS[ri].profession.replaceAll(',','ï¼Œ')];
    const marks=DATE_KEYS.map((k,di)=>tr.querySelectorAll('td')[3+di].querySelector('.status').textContent);
    const rate=tr.querySelector('.att-rate')?.textContent||'';
    const gsum=tr.querySelector('.guest-sum')?.textContent||'';
    const grate=tr.querySelector('.guest-rate')?.textContent||'';
    const o2osum=tr.querySelector('.o2o-sum')?.textContent||'';
    const o2orate=tr.querySelector('.o2o-rate')?.textContent||'';
    const perf=tr.querySelector('.perf-score')?.textContent||'';
    lines.push([...base,...marks,rate,gsum,grate,o2osum,o2orate,perf].join(','));
  });
  const bom = String.fromCharCode(65279);
  const blob=new Blob([bom+lines.join('\\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='æ ¸å¿ƒåœ˜æˆå“¡_10-01_11-05.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// === çµ±è¨ˆ ===
function updateTotals(){
  // æ¯æ—¥æœŸåˆè¨ˆï¼ˆä¾†è³“ç¸½å’Œä»¥äººæ•¸åˆè¨ˆï¼›ä¸€å°ä¸€ç¸½æ•¸ä»¥ã€Œä¸é‡è¤‡é…å°ã€è¨ˆï¼‰
  DATE_KEYS.forEach((k,di)=>{
    let g=0,y=0,r=0,guestSum=0,o2o=0;
    const seen=new Set(); // unique pair per day
    [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
      const cell=tr.querySelectorAll('td')[3+di];
      const btn=cell.querySelector('.status'); const v=btn.textContent;
      if(v==='ğŸŸ¢') g++; else if(v==='ğŸŸ¡') y++; else if(v==='ğŸ”´') r++;
      guestSum += parseInt(cell.querySelector('.guest-input')?.value||'0')||0;
      const partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]');
      partners.forEach(pj=>{ const a=Math.min(ri,pj), b=Math.max(ri,pj); const key=`${a}-${b}`; if(!seen.has(key)){ seen.add(key); o2o++; } });
    });
    const wrap=document.querySelector(`.totals[data-date="${k}"]`);
    wrap.innerHTML=`<span class="dot">ğŸŸ¢ ${g}</span> <span class="dot">ğŸŸ¡ ${y}</span> <span class="dot">ğŸ”´ ${r}</span> <span class="dot">ğŸ‘¥ ${guestSum}</span> <span class="dot">ğŸ¤ ${o2o}</span>`;
  });
  // åˆ—çµ±è¨ˆ
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>fillRightSummary(tr,ri));
  // çŸ©é™£
  buildMatrix();
}

function fillRightSummary(tr,ri){
  const cells=tr.querySelectorAll('td'); let present=0, guestCnt=0, guestDays=0, o2oSum=0, o2oDays=0;
  DATE_KEYS.forEach((k,di)=>{
    const cell=cells[3+di]; const v=cell.querySelector('.status').textContent;
    if(v==='ğŸŸ¢'||v==='ğŸŸ¡'){ present++; }
    const g=parseInt(cell.querySelector('.guest-input')?.value||'0')||0; guestCnt+=g; if(g>0 && (v==='ğŸŸ¢'||v==='ğŸŸ¡')) guestDays++;
    const partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]'); if((v==='ğŸŸ¢'||v==='ğŸŸ¡') && partners.length>0) o2oDays++; o2oSum+=partners.length;
  });
  const total=DATE_KEYS.length; const attRate= total? Math.round((present/total)*1000)/10 : 0; const guestRate= present? Math.round((guestDays/present)*1000)/10 : 0; const o2oRate= present? Math.round((o2oDays/present)*1000)/10 : 0; const perf=Math.round((0.5*attRate + 0.25*guestRate + 0.25*o2oRate)*10)/10; const base=3+DATE_KEYS.length; const vals=[attRate.toFixed(1)+'%', guestCnt, guestRate.toFixed(1)+'%', o2oSum, o2oRate.toFixed(1)+'%', perf.toFixed(1)+'%']; for(let i=0;i<6;i++){ const td=tr.querySelectorAll('td')[base+i]; td.textContent=vals[i]; td.className=['att-rate','guest-sum','guest-rate','o2o-sum','o2o-rate','perf-score'][i]; }
}

// === çŸ©é™£ ===
function buildMatrix(){
  const tbl=document.getElementById('matrix'); if(!tbl) return;
  const seenPerDay = DATE_KEYS.map(()=>new Set());
  const count=Array.from({length:MEMBERS.length},()=>Array(MEMBERS.length).fill(0));
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
    DATE_KEYS.forEach((k,di)=>{
      const cell=tr.querySelectorAll('td')[3+di];
      const partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]');
      partners.forEach(pj=>{
        const a=Math.min(ri,pj), b=Math.max(ri,pj);
        const key=`${a}-${b}`;
        if(!seenPerDay[di].has(key)){ seenPerDay[di].add(key); count[a][b]++; count[b][a]++; }
      });
    });
  });
  let html='<thead><tr><th>Name</th>';
  MEMBERS.forEach(m=> html+=`<th>${m.name}</th>`);
  html+='</tr></thead><tbody>';
  MEMBERS.forEach((m,i)=>{
    html+=`<tr><th>${m.name}</th>`;
    MEMBERS.forEach((n,j)=>{
      if (i === j) { html += '<td class="diag"></td>'; } else { const val = count[i][j] || 0; const cls = val > 0 ? ' class="lit"' : ''; html += `<td${cls}>${val}</td>`; }
    });
    html+='</tr>';
  });
  html+='</tbody>';
  tbl.innerHTML=html;
}

// === æœå°‹ ===
const q=document.getElementById('q');
q.addEventListener('input',()=>{
  const term=q.value.trim();
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
    const hit=!term || (MEMBERS[ri]?.name||'').includes(term) || (MEMBERS[ri]?.profession||'').includes(term);
    tr.style.display=hit? '':'none';
  });
});

// === åŒ¯å…¥æˆå“¡ ===
const importDialog=document.getElementById('importDialog'); const importBtn=document.getElementById('importBtn'); const doImport=document.getElementById('doImport'); const importText=document.getElementById('importText');
importBtn.addEventListener('click',()=>{ importText.value='1,å¾åœ‹è¯,ä¸­è—¥åŒ…è£è¨­å‚™è²·è³£æ¥­\\n2,å³å† ç’‹,ç†è²¡è¦åŠƒä¿éšªæ¥­\\n3,é˜å§µç¾š,åœŸåœ°é–‹ç™¼æ¥­\\n4,æå®‡æ™´,å¸‚èª¿æ¥­\\n5,é™³æ¸…ç‰,èŒ¶è£½å“æ‰¹ç™¼é›¶å”®\\n6,æ—ä½‘å„’,è¸ç‰›é¤Šæ®–è²·è³£æ¥­\\n7,æ—å½¥å®,ç±³ç³§å•†\\n8,é™³å»ºå®,è»ŸåŒ…è£å®¢è£½åŒ–å·¥å» \\n9,æ±Ÿèª ä»²,æµ·è‹”æ‰¹ç™¼é›¶å”®\\n10,ææœµå«»,å’–å•¡çƒ˜è±†æ¥­\\n11,é¾æ˜†ç¿°,æ±½è»Šéè†œæ¥­\\n12,å¾å­è¡¡,æ²¹å“å“ç‰Œå•†\\n13,å³å…¸è“‰,æ°‘äº‹è¨´è¨Ÿå¾‹å¸«'; importDialog.showModal(); });
doImport.addEventListener('click',()=>{ const lines=importText.value.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean); const parsed=[]; for(const ln of lines){ const parts=ln.split(/\\t|\\s*,\\s*/); if(parts.length>=3){ const id=Number(parts[0])||parsed.length+1; parsed.push({id,name:parts[1],profession:parts.slice(2).join(' ')}); } } if(parsed.length){ MEMBERS=parsed; localStorage.setItem(MEMBERS_KEY, JSON.stringify(MEMBERS)); buildTable(); updateTotals(); importDialog.close(); } else { alert('æœªåµæ¸¬åˆ°å¯ç”¨è³‡æ–™ï¼Œè«‹ç¢ºèªæ¯åˆ—æœ‰ï¼šç·¨è™Ÿ,å§“å,å°ˆæ¥­åˆ¥'); } });

// === åˆ—å° ===
function printPage(){ window.print(); }

// åˆå§‹åŒ–
buildTable(); updateTotals();
document.getElementById('saveBtn').addEventListener('click', save);
document.getElementById('loadBtn').addEventListener('click', load);
document.getElementById('clearBtn').addEventListener('click', clearAll);
document.getElementById('csvBtn').addEventListener('click', exportCSV);
document.getElementById('printBtn').addEventListener('click', printPage);
</script>

<!-- Firebase CDN (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
/* === Firestore Sync v2 (robust id + hooks + diagnostics) === */
(function(){
  const firebaseConfig = {
    apiKey: "AIzaSyDDZYbqfz-A5BcpKmO_TO8ot5AAp4bUeTE",
    authDomain: "bni-info-meeting.firebaseapp.com",
    projectId: "bni-info-meeting",
    storageBucket: "bni-info-meeting.firebasestorage.app",
    messagingSenderId: "943878549247",
    appId: "1:943878549247:web:a1ab47cbf589e3b1ab26ca",
    measurementId: "G-P2QGJ52GKW"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  try{ firebase.analytics(); }catch(e){}
  const db = firebase.firestore();
  const SNAP_COLL = "trafficSnapshots";
  // Map helper: given row object + date index, resolve base key and value
  function mapRowKeysDual(rowObj, di){
    const DK = (window.DATE_KEYS||[]);
    const DS = (window.DATES||[]);
    const dispKey = DK[di];           // e.g., "10/01"
    const isoKey  = DS[di];           // e.g., "2025-10-01"
    if (rowObj && typeof rowObj==='object'){
      if (dispKey && (dispKey in rowObj)) return {key: dispKey, val: rowObj[dispKey]};
      if (isoKey && (isoKey in rowObj))   return {key: isoKey,  val: rowObj[isoKey]};
      // try MM/DD -> ISO by borrowing year from DS[di]
      if (dispKey && /\d{2}\/\d{2}/.test(dispKey)){
        try{
          const y = (isoKey && /^\d{4}-\d{2}-\d{2}$/.test(isoKey)) ? isoKey.slice(0,4) : String(new Date().getFullYear());
          const iso2 = y + "-" + dispKey.replace(/\//g,"-");
          if (iso2 in rowObj) return {key: iso2, val: rowObj[iso2]};
        }catch(e){}
      }
    }
    return {key: dispKey||isoKey, val: ""};
  }

  // After cloud load, fill table using dual-key and (optionally) sync missing MM/DD fields back to Firestore
  async function autoSyncMMDDIfNeeded(rows){
    try{
      const DK = (window.DATE_KEYS||[]);
      const DS = (window.DATES||[]);
      if (!Array.isArray(rows) || !DK.length || !DS.length) return;
      // Build newRows with MM/DD filled from ISO when missing; do not overwrite existing MM/DD values
      const newRows = rows.map((row)=>{
        const r = Object.assign({}, row||{});
        for (let di=0; di<DK.length; di++){
          const dispKey = DK[di];
          const isoKey  = DS[di];
          if (!dispKey) continue;
          const copy = (src, dst) => {
            if (r[src] != null && r[src] !== "" && (r[dst] == null || r[dst] === "")) r[dst] = r[src];
          };
          copy(isoKey, dispKey);
          copy(isoKey + "_g", dispKey + "_g");
          copy(isoKey + "_1on1", dispKey + "_1on1");
          if (Array.isArray(r[isoKey + "_p"]) && (!Array.isArray(r[dispKey + "_p"]) || r[dispKey + "_p"].length === 0)){
            r[dispKey + "_p"] = r[isoKey + "_p"];
          }
        }
        return r;
      });
      // If nothing changed, skip write
      let changed = false;
      for (let i=0;i<rows.length;i++){
        const a = rows[i]||{}, b = newRows[i]||{};
        if (JSON.stringify(a) !== JSON.stringify(b)){ changed = true; break; }
      }
      if (changed){
        const snapId = getSnapId();
        await db.collection(SNAP_COLL).doc(snapId).set({ rows: newRows }, { merge: true });
        try{ localStorage.setItem(window.STORAGE_KEY, JSON.stringify(newRows)); }catch(e){}
        if (window.showToast) window.showToast("å·²è‡ªå‹•è£œé½Š MM/DD æ¬„ä½ä¸¦åŒæ­¥åˆ°é›²ç«¯", "ok");
        // update in-memory cache too
        window.__FIRE_LAST_ROWS = newRows;
        return newRows;
      }
      return rows;
    }catch(e){
      if (window.showToast) window.showToast("è‡ªå‹•è£œé½Š MM/DD å¤±æ•—ï¼š" + e, "err");
      return rows;
    }
  }
  // Wait until matrix/table is ready, then apply rows (avoid early apply on empty DOM)
  function waitForMatrixAndApply(rows){
    try{
      const start = Date.now();
      const limit = 6000; // up to 6s
      const tick = 160;   // check every 160ms
      function ready(){
        return document.getElementById('tbody') || document.querySelector('#matrix table');
      }
      if (ready()){
        try{ applyRows(rows); }catch(e){}
        return;
      }
      const tm = setInterval(()=>{
        if (ready() || (Date.now() - start > limit)){
          clearInterval(tm);
          try{ applyRows(rows); }catch(e){}
        }
      }, tick);
    }catch(e){}
  }
  function hardTakeover(rows){
    try{
      if (rows){
        window.__FIRE_LAST_ROWS = rows;
        try{ localStorage.setItem(window.STORAGE_KEY, JSON.stringify(rows)); }catch(e){}
      }
      // Permanently tame legacy window.load: always re-apply cloud rows if invoked
      (function(){
        const orig = typeof window.load === "function" ? window.load : null;
        window.load = function(){
          try{ if (window.__FIRE_LAST_ROWS && typeof applyRows === "function"){ applyRows(window.__FIRE_LAST_ROWS); return; } }catch(e){}
          if (orig) return orig.apply(this, arguments);
        };
      })();
      // Replace #loadBtn / [data-action=load] with clean clones that only trigger cloud
      const sels = ["#loadBtn","[data-action=load]"];
      sels.forEach(sel=>{
        document.querySelectorAll(sel).forEach(btn=>{
          try{
            const c = btn.cloneNode(true);
            btn.replaceWith(c);
            c.addEventListener("click", function(ev){ ev.preventDefault(); ev.stopImmediatePropagation(); loadFromFirestore(); }, true);
          }catch(e){}
        });
      });
    }catch(e){}
  }
  // Aggressive keep-on-screen: repeatedly re-apply for a short window and suppress legacy handlers
  function cloudHold(rows){
    try{
      if (!rows) return;
      window.__FIRE_LAST_ROWS = rows;
      // 1) keep localStorage in sync
      try{ localStorage.setItem(window.STORAGE_KEY, JSON.stringify(rows)); }catch(e){}
      // 2) disable legacy window.load temporarily
      const origLoad = typeof window.load === "function" ? window.load : null;
      if (origLoad){ window.load = function(){}; setTimeout(()=>{ window.load = origLoad; }, 12000); }
      // 3) global capture to stop other click/change handlers that might overwrite
      const blocker = function(e){ e.stopImmediatePropagation(); };
      const evs = ["click","change","input"];
      evs.forEach(ev=>document.addEventListener(ev, blocker, true));
      setTimeout(()=>{ evs.forEach(ev=>document.removeEventListener(ev, blocker, true)); }, 3000);
      // 4) aggressive reapply loop for 3s
      const t0 = Date.now();
      (function loop(){
        try{
          if (Date.now() - t0 > 3000) return;
          if (typeof applyRows === "function") applyRows(rows);
        }catch(e){}
        setTimeout(loop, 120);
      })();
      // 5) also watch DOM rebuilds for 6s
      try{
        const stopAt = Date.now() + 6000;
        const target = document.getElementById('tbody') || document.querySelector('#matrix') || document.body;
        if (target){
          let tm=null;
          const ob = new MutationObserver(()=>{
            if (Date.now()>stopAt){ ob.disconnect(); return; }
            clearTimeout(tm);
            tm = setTimeout(()=>{ try{ applyRows(rows); }catch(e){} }, 40);
          });
          ob.observe(target, {childList:true, subtree:true});
          setTimeout(()=>ob.disconnect(), 6200);
        }
      }catch(e){}
    }catch(e){}
  }
  function sealCloudRows(rows){
    try{
      if (rows) {
        try { localStorage.setItem(window.STORAGE_KEY, JSON.stringify(rows)); } catch(e) {}
        window.__FIRE_LAST_ROWS = rows;
      }
      const WINDOW_MS = 15000; // 15s hard-protect window
      const started = Date.now();

      // 1) Temporarily prefer cloud rows via localStorage getter
      try{
        const LS = window.localStorage;
        const nativeGet = LS.getItem.bind(LS);
        LS.getItem = function(k){
          try{
            if (k === window.STORAGE_KEY && window.__FIRE_LAST_ROWS && Date.now()-started < WINDOW_MS){
              return JSON.stringify(window.__FIRE_LAST_ROWS);
            }
          }catch(e){}
          return nativeGet(k);
        };
        setTimeout(()=>{ try{ LS.getItem = nativeGet; }catch(e){} }, WINDOW_MS+200);
      }catch(e){}

      // 2) Wrap window.load() to avoid wiping cloud data
      (function(){
        const orig = typeof window.load === "function" ? window.load : null;
        window.load = function(){
          try{
            if (window.__FIRE_LAST_ROWS && Date.now()-started < WINDOW_MS){
              if (typeof applyRows === "function") applyRows(window.__FIRE_LAST_ROWS);
              return; // block legacy local overwrite
            }
          }catch(e){}
          if (orig) return orig.apply(this, arguments);
        };
        setTimeout(()=>{ if (orig) window.load = orig; }, WINDOW_MS+200);
      })();

      // 3) Re-apply after table rebuilds within window
      (function(){
        const stopAt = Date.now() + WINDOW_MS;
        const target = document.getElementById('tbody') || document.querySelector('#matrix') || document.body;
        if (!target) return;
        let t=null;
        const ob = new MutationObserver(()=>{
          if (Date.now() > stopAt) { ob.disconnect(); return; }
          if (window.__FIRE_LAST_ROWS && typeof applyRows === 'function'){
            clearTimeout(t);
            t = setTimeout(()=>{ try{ applyRows(window.__FIRE_LAST_ROWS); }catch(e){} }, 40);
          }
        });
        ob.observe(target, {childList:true, subtree:true});
        setTimeout(()=>ob.disconnect(), WINDOW_MS+300);
      })();
    }catch(e){}
  }

  function getSnapId(){ return "core-team-traffic-v3"; }catch(e){}
    const sk = (window.STORAGE_KEY || "core-team-traffic");
    return sk + "-v3";
  }
  function setSnapId(id){ try{ localStorage.setItem("FIRE_SNAP_ID", id); }catch(e){} }
  function getSnapshot(){ if (typeof snapshot === 'function') return snapshot(); return null; }

  var __FIRE_LAST_ROWS=null;
function applyRows(rows){
__FIRE_LAST_ROWS = rows;
    const tbody = document.getElementById('tbody');
    if (!tbody) return;
    if (typeof buildTable === 'function') buildTable();
    const DATE_KEYS = window.DATE_KEYS || [];
    [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
      const cells=tr.querySelectorAll('td');
      DATE_KEYS.forEach((k,di)=>{
        const cell=cells[3+di];
        const b=cell.querySelector('.status');
        const g=cell.querySelector('.guest-input');
        const p=cell.querySelector('.pair-btn');
        const pill=cell.querySelector('.o2o-pill');
        const v=rows[ri]?.[k]||''; b.setAttribute('aria-label',v); b.textContent=v;
        const gval=parseInt(rows[ri]?.[k+'_g'])||0; if(g) g.value=String(gval);
        const partners=Array.isArray(rows[ri]?.[k+'_p'])? rows[ri][k+'_p'] : []; p.dataset.partners = JSON.stringify(partners);
        const n = partners.length>0 ? partners.length : (parseInt(rows[ri]?.[k+'_1on1'])||0);
        pill.dataset.count = String(n); pill.textContent = `ğŸ¤ ${n}`;
        b.classList.toggle('o2o', n>0);
      });
      if (typeof fillRightSummary === 'function') fillRightSummary(tr,ri);
    });
    if (typeof updateTotals === 'function') updateTotals();
  }

  async function saveToFirestore(){
    const rows = getSnapshot();
    if (!rows){ showToast("ç„¡æ³•æ“·å–å¿«ç…§ï¼šsnapshot() ä¸å­˜åœ¨ã€‚", "ok"); return; }
    const snapId = getSnapId();
    const payload = {
      rows,
      members: (window.MEMBERS || []),
      dateKeys: (window.DATE_KEYS || []),
      dates: (window.DATES || []),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      note: "saved from v3.2 locked tidy page"
    };
    await db.collection(SNAP_COLL).doc(snapId).set(payload, { merge: true });
    try{ localStorage.setItem(window.STORAGE_KEY, JSON.stringify(rows)); }catch(e){}
    setSnapId(snapId);
    showToast("âœ… å·²å­˜åˆ° Firestore\nè·¯å¾‘: " + SNAP_COLL + "/" + snapId, "ok");
  }

  async function loadFromFirestore(){
    const snapId = getSnapId();
    const docRef = db.collection(SNAP_COLL).doc(snapId);
    const doc = await docRef.get();
    if (doc.exists){
      try{ showToast("å·²é€£ç·šåˆ° Firestoreï¼š"+SNAP_COLL+"/"+getSnapId(), "ok"); }catch(e){}
      const data = doc.data() || {};
      if (Array.isArray(data.members) && data.members.length){
        try{ window.MEMBERS = data.members; localStorage.setItem(window.MEMBERS_KEY, JSON.stringify(window.MEMBERS)); }catch(e){}
      }
      if (Array.isArray(data.rows)){
        applyRows(data.rows);
        try{ localStorage.setItem(window.STORAGE_KEY, JSON.stringify(data.rows)); }catch(e){}
        // Re-apply once if table gets rebuilt shortly after
        (function(){
          var once=true; var t0=Date.now();
          var tbody=document.getElementById('tbody'); if(!tbody) return;
          var mo=new MutationObserver(function(){
            if(once && Date.now()-t0<3000 && __FIRE_LAST_ROWS){ applyRows(__FIRE_LAST_ROWS); once=false; mo.disconnect(); }
          });
          mo.observe(tbody.parentElement||document.body,{childList:true,subtree:true});
          setTimeout(function(){ try{ mo.disconnect(); }catch(e){} }, 3500);
        })();
        showToast("âœ… å·²å¾ Firestore è®€å–\nè·¯å¾‘: " + SNAP_COLL + "/" + snapId, "ok");
        return;
      }
      showToast("âš ï¸ é›²ç«¯æ–‡ä»¶å­˜åœ¨ï¼Œä½† rows æ¬„ä½æ˜¯ç©ºçš„ã€‚", "ok");
    }else{
      showToast("âš ï¸ æ‰¾ä¸åˆ°é›²ç«¯æ–‡ä»¶: " + SNAP_COLL + "/" + snapId + "\nå°‡å›é€€è®€æœ¬æ©Ÿã€‚", "ok");
      if (typeof load === 'function'){ load(); }
    }
  }

  function hookButtons(){
    const ids = [["saveBtn", saveToFirestore], ["loadBtn", loadFromFirestore]];
    ids.forEach(([id, fn])=>{
      const el=document.getElementById(id);
      if (el){ el.addEventListener("click", function(e){ e.preventDefault(); e.stopImmediatePropagation(); fn().catch(err=>showToast("Firestore éŒ¯èª¤: "+err), "ok"); }); }
    });
    // Fallback by text content
    if (!document.getElementById("saveBtn")){
      const b=[...document.querySelectorAll("button, a")].find(b=>/å„²å­˜|ä¿å­˜|Save/i.test(b.textContent||""));
      if (b) b.addEventListener("click", e=>{ e.preventDefault(); e.stopImmediatePropagation(); saveToFirestore().catch(err=>showToast("Firestore éŒ¯èª¤: "+err), "ok"); });
    }
    if (!document.getElementById("loadBtn")){
      const b=[...document.querySelectorAll("button, a")].find(b=>/è®€å–|è¼‰å…¥|Load/i.test(b.textContent||""));
      if (b) b.addEventListener("click", e=>{ e.preventDefault(); e.stopImmediatePropagation(); loadFromFirestore().catch(err=>showToast("Firestore éŒ¯èª¤: "+err), "ok"); });
    }
  }

  document.addEventListener("DOMContentLoaded", function(){ setTimeout(hookButtons, 500); });

  window.__fireSnap = { saveToFirestore, loadFromFirestore };
  // Guard: neutralize legacy handlers on load/save buttons by cloning them once at DOM ready
  document.addEventListener("DOMContentLoaded", function(){
    ["#saveBtn","[data-action=save]","#loadBtn","[data-action=load]"].forEach(sel=>{
      document.querySelectorAll(sel).forEach(btn=>{
        try{
          const c = btn.cloneNode(true);
          btn.replaceWith(c);
          if (sel.includes("save")) c.addEventListener("click", e=>{ e.preventDefault(); e.stopImmediatePropagation(); saveToFirestore(); }, true);
          if (sel.includes("load")) c.addEventListener("click", e=>{ e.preventDefault(); e.stopImmediatePropagation(); loadFromFirestore(); }, true);
        }catch(e){}
      });
    });
  });
  // Guard: if user clicked "è®€å–" for cloud, neutralize legacy load() briefly
  (function(){
    const origLoad = typeof window.load === "function" ? window.load : null;
    document.addEventListener("click", function(e){
      const t = e.target;
      if (!t) return;
      if (t.closest && (t.closest("#loadBtn") || t.closest("[data-action='load']"))) {
        try{ window.__FIRE_FROM_CLOUD_INTENT_AT = Date.now(); }catch(e){}
        if (origLoad){
          window.load = function(){ /* blocked during cloud intent */ };
          setTimeout(()=>{ window.load = origLoad; }, 15000);
        }
      }
    }, true);
  })();
})();
</script>
<script>
(function(){
  const btn=document.getElementById("forceApplyBtn");
  if(!btn) return;
  btn.addEventListener("click", function(e){
    e.preventDefault(); e.stopImmediatePropagation();
    try{
      const rows = window.__FIRE_LAST_ROWS;
      if (!rows){ return window.showToast ? showToast("æ²’æœ‰å¯å¥—ç”¨çš„é›²ç«¯ rows", "warn") : null; }
      if (!document.getElementById('tbody') && typeof window.buildTable==='function'){ try{ buildTable(); }catch(e){} }
      if (typeof window.applyRows==='function'){ applyRows(rows); }
      if (window.showToast) showToast("å·²å¼·åˆ¶å¥—ç”¨é›²ç«¯ rows", "ok");
    }catch(err){
      if (window.showToast) showToast("å¼·åˆ¶å¥—ç”¨å¤±æ•—ï¼š" + err, "err");
    }
  }, true);
})();
</script>



<script>
/* === CloudRead Stabilizer v1 === */
(function(){
  // Set intent when clicking "è®€å–/è¼‰å…¥/Load" buttons
  function markIntent(){
    window.__FIRE_FROM_CLOUD_INTENT_AT = Date.now();
  }
  document.addEventListener("DOMContentLoaded", function(){
    // ID-based
    ["#loadBtn","[data-action='load']"].forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        el.addEventListener("click", markIntent, true);
      });
    });
    // Text fallback
    Array.from(document.querySelectorAll("button,a")).forEach(el=>{
      if (/è®€å–|è¼‰å…¥|Load/i.test(el.textContent||"")) {
        el.addEventListener("click", markIntent, true);
      }
    });
  });

  // Patch applyRows to capture latest rows and persist to localStorage when intent is set
  (function(){
    const prev = window.applyRows;
    if (typeof prev === "function"){
      window.applyRows = function(rows){
        try {
          window.__FIRE_LAST_ROWS = rows;
          if (window.__FIRE_FROM_CLOUD_INTENT_AT && Date.now() - window.__FIRE_FROM_CLOUD_INTENT_AT < 8000) {
            try { localStorage.setItem(window.STORAGE_KEY, JSON.stringify(rows)); } catch(e) {}
            startReapplyWatcher();
          }
        } catch(e) {}
        return prev.apply(this, arguments);
      };
    }
  })();

  // For a short window, prefer cloud rows over localStorage when someone reads STORAGE_KEY
  (function(){
    try{
      const LS = window.localStorage;
      if (!LS) return;
      const nativeGet = LS.getItem.bind(LS);
      LS.getItem = function(k){
        try{
          if (k === window.STORAGE_KEY &&
              window.__FIRE_LAST_ROWS &&
              window.__FIRE_FROM_CLOUD_INTENT_AT &&
              Date.now() - window.__FIRE_FROM_CLOUD_INTENT_AT < 8000){
            return JSON.stringify(window.__FIRE_LAST_ROWS);
          }
        }catch(e){}
        return nativeGet(k);
      };
    }catch(e){}
  })();

  // Observe table rebuild shortly after cloud load and re-apply once
  window.startReapplyWatcher = function(){
    try{
      const stopAt = Date.now() + 4000;
      const target = document.getElementById('tbody') || document.querySelector('#matrix') || document.body;
      if (!target) return;
      const ob = new MutationObserver(()=>{
        if (Date.now() > stopAt) { ob.disconnect(); return; }
        if (window.__FIRE_LAST_ROWS && typeof applyRows === 'function'){
          try{ applyRows(window.__FIRE_LAST_ROWS); }catch(e){}
        }
      });
      ob.observe(target, {childList:true, subtree:true});
      setTimeout(()=>ob.disconnect(), 4200);
    }catch(e){}
  };
})();
</script>


<script>
/* === Edit Gate v1 (default read-only; password to edit) === */
(function(){
  // Config
  const PASS = "2614";
  const ALLOW_SELECTORS = [
    "#loadBtn", "[data-action='load']",
    "#saveBtn", "[data-action='save']",
    "#editToggleBtn", "#editBar *",
    "a[href]", "details", "summary"
  ];

  // State
  let editing = false;
  function isAllowed(target){
    return ALLOW_SELECTORS.some(sel => target.closest(sel));
  }

  // Intercept interactions: if not editing, block actions inside matrix & form controls
  const blockSelectors = "input, textarea, select, button, [contenteditable], #matrix, #matrix *";
  function gateHandler(e){
    if (editing) return;
    const t = e.target;
    if (!t) return;
    if (isAllowed(t)) return; // allow load/save/edit buttons
    if (t.closest(blockSelectors)){
      e.preventDefault();
      e.stopPropagation();
      return false;
    }
  }
  ["click","dblclick","mousedown","pointerdown","keydown","input","change","touchstart"].forEach(ev=>{
    document.addEventListener(ev, gateHandler, true);
  });

  // Toggle edit with password
  const btn = document.getElementById("editToggleBtn");
  function refreshUI(){
    btn.classList.toggle("on", editing);
    btn.textContent = editing ? "ç·¨è¼¯ä¸­" : "ç·¨è¼¯";
    document.documentElement.classList.toggle("editing", editing);
  }
  btn.addEventListener("click", ()=>{
    if (!editing){
      const v = window.prompt("");
      if (v === PASS){ editing = true; refreshUI(); }
    }else{
      editing = false; refreshUI();
    }
  });
  refreshUI();
})();
</script>


<script>
/* === CloudRead Stabilizer v1.2 (longer window + force re-apply) === */
(function(){
  const WINDOW_MS = 12000; // 12s window to resist overwrites

  function markIntent(){ window.__FIRE_FROM_CLOUD_INTENT_AT = Date.now(); }
  document.addEventListener("DOMContentLoaded", function(){
    ["#loadBtn","[data-action='load']"].forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>el.addEventListener("click", markIntent, true));
    });
    Array.from(document.querySelectorAll("button,a")).forEach(el=>{
      if (/è®€å–|è¼‰å…¥|Load/i.test(el.textContent||"")) el.addEventListener("click", markIntent, true);
    });
  });

  // Patch applyRows to cache rows & persist to local when cloud intent exists
  (function(){
    const prev = window.applyRows;
    if (typeof prev === "function"){
      window.applyRows = function(rows){
        try {
          window.__FIRE_LAST_ROWS = rows;
          if (window.__FIRE_FROM_CLOUD_INTENT_AT && Date.now() - window.__FIRE_FROM_CLOUD_INTENT_AT < WINDOW_MS) {
            try { localStorage.setItem(window.STORAGE_KEY, JSON.stringify(rows)); } catch(e) {}
            startReapplyWatcher();
          }
        } catch(e) {}
        return prev.apply(this, arguments);
      };
    }
  })();

  // Shim localStorage.getItem to prefer cloud rows during the window
  (function(){
    try{
      const LS = window.localStorage;
      if (!LS) return;
      const nativeGet = LS.getItem.bind(LS);
      LS.getItem = function(k){
        try{
          if (k === window.STORAGE_KEY &&
              window.__FIRE_LAST_ROWS &&
              window.__FIRE_FROM_CLOUD_INTENT_AT &&
              Date.now() - window.__FIRE_FROM_CLOUD_INTENT_AT < WINDOW_MS){
            return JSON.stringify(window.__FIRE_LAST_ROWS);
          }
        }catch(e){}
        return nativeGet(k);
      };
    }catch(e){}
  })();

  // Re-apply rows if DOM rebuilds shortly after cloud read
  window.startReapplyWatcher = function(){
    try{
      const stopAt = Date.now() + 6000;
      const target = document.getElementById('tbody') || document.querySelector('#matrix') || document.body;
      if (!target) return;
      let t=null;
      const ob = new MutationObserver(()=>{
        if (Date.now() > stopAt) { ob.disconnect(); return; }
        if (window.__FIRE_LAST_ROWS && typeof applyRows === 'function'){
          clearTimeout(t);
          t = setTimeout(()=>{ try{ applyRows(window.__FIRE_LAST_ROWS); }catch(e){} }, 40);
        }
      });
      ob.observe(target, {childList:true, subtree:true});
      setTimeout(()=>ob.disconnect(), 6200);
    }catch(e){}
  };
})();
</script>


<script>
/* === applyRows override: dual key (MM/DD & ISO) mapper === */
(function(){
  const prev = window.applyRows;
  window.applyRows = function(rows){
    const DK = (window.DATE_KEYS||[]);
    const DS = (window.DATES||[]);
    const tbody = document.getElementById('tbody');
    if (!tbody && typeof window.buildTable==='function'){ try{ buildTable(); }catch(e){} }
    [...(document.getElementById('tbody')||{querySelectorAll:()=>[]}).querySelectorAll('tr')].forEach((tr,ri)=>{
      const cells = tr.querySelectorAll('td');
      DK.forEach((k,di)=>{
        const cell=cells[3+di]; if(!cell) return;
        const b=cell.querySelector('.status');
        const g=cell.querySelector('.guest-input');
        const p=cell.querySelector('.pair-btn');
        const pill=cell.querySelector('.o2o-pill');
        const rowObj = rows && rows[ri] || {};
        // resolve key
        const dispKey = DK[di];
        const isoKey  = DS[di];
        let baseKey = null;
        if (rowObj && Object.prototype.hasOwnProperty.call(rowObj, dispKey)) baseKey = dispKey;
        else if (rowObj && Object.prototype.hasOwnProperty.call(rowObj, isoKey)) baseKey = isoKey;
        else if (/^\d{2}\/\d{2}$/.test(String(dispKey||""))){
          try{
            const y = (isoKey && /^\d{4}-\d{2}-\d{2}$/.test(isoKey)) ? isoKey.slice(0,4) : String(new Date().getFullYear());
            const iso2 = y + "-" + String(dispKey).replace(/\//g,"-");
            if (Object.prototype.hasOwnProperty.call(rowObj, iso2)) baseKey = iso2;
          }catch(e){}
        }
        if (!baseKey) baseKey = dispKey || isoKey || "";
        // values
        const v = rowObj[baseKey] || "";
        if (b){ b.setAttribute('aria-label', v); b.textContent = v; }
        const gval = parseInt(rowObj[baseKey + '_g']) || 0; if (g) g.value = String(gval);
        const partners = Array.isArray(rowObj[baseKey + '_p']) ? rowObj[baseKey + '_p'] : [];
        if (p) p.dataset.partners = JSON.stringify(partners);
        const n = partners.length>0 ? partners.length : (parseInt(rowObj[baseKey + '_1on1'])||0);
        if (pill){ pill.dataset.count = String(n); pill.textContent = `ğŸ¤ ${n}`; }
        if (b) b.classList.toggle('o2o', n>0);
      });
      if (typeof window.fillRightSummary === 'function') try{ fillRightSummary(tr,ri); }catch(e){}
    });
    if (typeof window.updateTotals === 'function') try{ updateTotals(); }catch(e){}
    return rows;
  };
  // If there is a cached cloud rows, apply once
  if (window.__FIRE_LAST_ROWS){ try{ window.applyRows(window.__FIRE_LAST_ROWS); }catch(e){} }
})();
</script>


<script>
/* === applyRows override: dual key (MM/DD & ISO) mapper === */
(function(){
  const prev = window.applyRows;
  window.applyRows = function(rows){
    const DK = (window.DATE_KEYS||[]);
    const DS = (window.DATES||[]);
    const tbody = document.getElementById('tbody');
    if (!tbody && typeof window.buildTable==='function'){ try{ buildTable(); }catch(e){} }
    const TB = document.getElementById('tbody');
    if (!TB) return rows;
    [...TB.querySelectorAll('tr')].forEach((tr,ri)=>{
      const cells = tr.querySelectorAll('td');
      DK.forEach((_,di)=>{
        const cell=cells[3+di]; if(!cell) return;
        const b=cell.querySelector('.status');
        const g=cell.querySelector('.guest-input');
        const p=cell.querySelector('.pair-btn');
        const pill=cell.querySelector('.o2o-pill');
        const rowObj = rows && rows[ri] || {};
        // dual-key resolve
        const got = (function(){
          const dispKey = DK[di];
          const isoKey  = DS[di];
          if (rowObj && Object.prototype.hasOwnProperty.call(rowObj, dispKey)) return {key: dispKey, val: rowObj[dispKey]};
          if (rowObj && Object.prototype.hasOwnProperty.call(rowObj, isoKey))  return {key: isoKey,  val: rowObj[isoKey]};
          if (/^\d{2}\/\d{2}$/.test(String(dispKey||""))){
            try{
              const y = (isoKey && /^\d{4}-\d{2}-\d{2}$/.test(isoKey)) ? isoKey.slice(0,4) : String(new Date().getFullYear());
              const iso2 = y + "-" + String(dispKey).replace(/\//g,"-");
              if (Object.prototype.hasOwnProperty.call(rowObj, iso2)) return {key: iso2, val: rowObj[iso2]};
            }catch(e){}
          }
          return {key: dispKey||isoKey, val: ""};
        })();
        const baseKey = got.key;
        const v = got.val || "";
        if (b){ b.setAttribute('aria-label', v); b.textContent = v; }
        const gval = parseInt((rowObj||{})[baseKey + '_g']) || 0; if (g) g.value = String(gval);
        const partners = Array.isArray((rowObj||{})[baseKey + '_p']) ? (rowObj||{})[baseKey + '_p'] : [];
        if (p) p.dataset.partners = JSON.stringify(partners);
        const n = partners.length>0 ? partners.length : (parseInt((rowObj||{})[baseKey + '_1on1'])||0);
        if (pill){ pill.dataset.count = String(n); pill.textContent = `ğŸ¤ ${n}`; }
        if (b) b.classList.toggle('o2o', n>0);
      });
      if (typeof window.fillRightSummary === 'function') try{ fillRightSummary(tr,ri); }catch(e){}
    });
    if (typeof window.updateTotals === 'function') try{ updateTotals(); }catch(e){}
    return rows;
  };
})();
</script>

<!-- === Cloud Debug Panel + Fixed DocId + Force Apply === -->
<style>
#__toastRoot{position:fixed;right:16px;top:16px;z-index:2147483647;display:flex;flex-direction:column;gap:8px}
.toast{background:#111827;color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.2);opacity:.98}
.toast.ok{background:#065f46}.toast.warn{background:#92400e}.toast.err{background:#7f1d1d}
#cloudDiag{position:fixed;bottom:16px;right:16px;background:#0b1020;color:#e5f0ff;border:1px solid #3b82f6;border-radius:12px;padding:10px 12px;z-index:2147483646;box-shadow:0 8px 24px rgba(0,0,0,.35);font-size:12px;min-width:260px}
#cloudDiag h4{margin:0 0 6px 0;font-size:12px;font-weight:700;color:#93c5fd}
#cloudDiag pre{margin:6px 0;max-height:140px;overflow:auto;background:#0a0f1a;padding:6px 8px;border-radius:8px}
#cloudDiag .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
#cloudDiag button{padding:4px 8px;border:1px solid #93c5fd;background:#0a1222;color:#cfe1ff;border-radius:8px;cursor:pointer}
#cloudDiag small{opacity:.85}
</style>
<div id="__toastRoot"></div>
<div id="cloudDiag" role="status" aria-live="polite">
  <h4>é›²ç«¯è¨ºæ–·é¢æ¿</h4>
  <div class="row"><span>æ–‡ä»¶è·¯å¾‘</span><small id="cd_path">trafficSnapshots/core-team-traffic-v3</small></div>
  <div class="row"><span>rows é•·åº¦</span><small id="cd_len">-</small></div>
  <div class="row"><span>å«è³‡æ–™ï¼Ÿ</span><small id="cd_has">-</small></div>
  <div class="row"><span>ç¬¬ä¸€ç­†éµ</span><small id="cd_keys">-</small></div>
  <div class="row"><span></span><button id="cd_force">å¼·åˆ¶å¥—ç”¨é›²ç«¯</button></div>
  <pre id="cd_preview">ï¼ˆæˆåŠŸè®€å–å¾Œæœƒé¡¯ç¤ºå‰1ç­†å…§å®¹ï¼‰</pre>
</div>
<script>
/* â€”â€” å°å·¥å…· â€”â€” */
function showToast(m,t){try{const r=document.getElementById("__toastRoot");const e=document.createElement("div");e.className="toast "+(t||"ok");e.innerHTML=m;r.appendChild(e);setTimeout(()=>{e.style.transition="opacity .25s";e.style.opacity="0";setTimeout(()=>e.remove(),260)},2200)}catch(e){}}
function __setTxt(id,val){const el=document.getElementById(id); if(el) el.textContent=String(val);}
function __keys(o){try{return Object.keys(o||{}).slice(0,8).join(", ");}catch(e){return "-";}}
function __pretty(o){try{return JSON.stringify(o,null,2);}catch(e){return String(o);}}
function __hasRows(rows){if(!Array.isArray(rows))return false;for(let i=0;i<rows.length;i++){if(rows[i]&&Object.keys(rows[i]).length)return true}return false;}
window.__showCloudDiag=function(rows,path){
  __setTxt('cd_path', path||'trafficSnapshots/core-team-traffic-v3');
  __setTxt('cd_len', Array.isArray(rows)? rows.length : 'éé™£åˆ—');
  __setTxt('cd_has', __hasRows(rows)? 'æ˜¯' : 'å¦');
  __setTxt('cd_keys', Array.isArray(rows)&&rows[0]? __keys(rows[0]) : '-');
  const pv=document.getElementById('cd_preview');
  if(pv) pv.textContent = Array.isArray(rows)&&rows[0]? __pretty(rows[0]) : 'ï¼ˆæ²’æœ‰å¯é¡¯ç¤ºçš„å…§å®¹ï¼‰';
};
/* å›ºå®š docIdï¼štrafficSnapshots/core-team-traffic-v3 */
(function(){
  if(typeof getSnapId!=="function"){
    window.getSnapId=function(){ return "core-team-traffic-v3"; };
  }else{
    const _g=getSnapId; window.getSnapId=function(){ try{return "core-team-traffic-v3";}catch(e){return _g();} };
  }
})();
/* MM/DD èˆ‡ ISO äº’é€šçš„ applyRows è¦†å¯«ï¼ˆä¿è­‰èƒ½åƒåˆ° 2025-10-01 æˆ– 10/01ï¼‰ */
(function(){
  const prev=window.applyRows;
  window.applyRows=function(rows){
    const DK=window.DATE_KEYS||[];   // 10/01
    const DS=window.DATES||[];       // 2025-10-01
    if(!document.getElementById('tbody') && typeof window.buildTable==='function'){ try{ buildTable(); }catch(e){} }
    const TB=document.getElementById('tbody'); if(!TB) return rows;
    [...TB.querySelectorAll('tr')].forEach((tr,ri)=>{
      const cells=tr.querySelectorAll('td');
      DK.forEach((dispKey,di)=>{
        const isoKey=DS[di]; const cell=cells[3+di]; if(!cell)return;
        const b=cell.querySelector('.status');
        const g=cell.querySelector('.guest-input');
        const p=cell.querySelector('.pair-btn');
        const pill=cell.querySelector('.o2o-pill');
        const row=rows && rows[ri] || {};
        let baseKey=null;
        if(Object.prototype.hasOwnProperty.call(row, dispKey)) baseKey=dispKey;
        else if(Object.prototype.hasOwnProperty.call(row, isoKey)) baseKey=isoKey;
        else if(/^\d{2}\/\d{2}$/.test(String(dispKey||""))){
          const y=(isoKey && /^\d{4}-\d{2}-\d{2}$/.test(isoKey))? isoKey.slice(0,4) : String(new Date().getFullYear());
          const iso2=y+"-"+String(dispKey).replace(/\//g,"-");
          if(Object.prototype.hasOwnProperty.call(row, iso2)) baseKey=iso2;
        }
        if(!baseKey) baseKey=dispKey||isoKey||"";
        const v=row[baseKey] || ""; if(b){ b.setAttribute('aria-label',v); b.textContent=v; }
        const gval=parseInt(row[baseKey+'_g'])||0; if(g) g.value=String(gval);
        const partners=Array.isArray(row[baseKey+'_p'])? row[baseKey+'_p'] : [];
        if(p) p.dataset.partners=JSON.stringify(partners);
        const n=partners.length>0? partners.length : (parseInt(row[baseKey+'_1on1'])||0);
        if(pill){ pill.dataset.count=String(n); pill.textContent=`ğŸ¤ ${n}`; }
        if(b) b.classList.toggle('o2o', n>0);
      });
      if(typeof window.fillRightSummary==='function'){ try{ fillRightSummary(tr,ri); }catch(e){} }
    });
    if(typeof window.updateTotals==='function'){ try{ updateTotals(); }catch(e){} }
    return rows;
  };
  if(prev && window.__FIRE_LAST_ROWS){ try{ window.applyRows(window.__FIRE_LAST_ROWS); }catch(e){} }
})();
/* ç¶å®šã€Œé›²ç«¯å„²å­˜/è®€å–ã€ï¼šç¢ºä¿èµ° Firestore (__fireSnap) */
(function(){
  function bind(btn, fn){
    if(!btn || !fn) return;
    const c=btn.cloneNode(true); btn.replaceWith(c);
    c.addEventListener('click', function(e){
      e.preventDefault(); e.stopImmediatePropagation();
      try{ const p=fn(); if(p && p.catch){ p.catch(err=>showToast("Firestore éŒ¯èª¤ï¼š"+err,"err")); } }
      catch(err){ showToast("Firestore åŸ·è¡Œå¤±æ•—ï¼š"+err,"err"); }
    }, true);
  }
  function tryBind(){
    const s=document.getElementById('saveBtn');
    const l=document.getElementById('loadBtn');
    const snap=window.__fireSnap;
    if(!snap) return false;
    if(s) bind(s, snap.saveToFirestore || snap.save);
    if(l) bind(l, snap.loadFromFirestore || snap.load);
    return !!(s||l);
  }
  let t=0, iv=setInterval(()=>{ t++; if(tryBind()||t>40) clearInterval(iv); }, 200);
  try{
    const ob=new MutationObserver(()=>tryBind());
    ob.observe(document.body, {childList:true, subtree:true});
    setTimeout(()=>ob.disconnect(), 20000);
  }catch(e){}
})();
/* è®€å–å¾Œæ›´æ–°è¨ºæ–·é¢æ¿ + å¼·åˆ¶å¥—ç”¨éˆ• */
(function(){
  const btn=document.getElementById('cd_force');
  if(btn) btn.addEventListener('click', function(e){
    e.preventDefault(); e.stopImmediatePropagation();
    try{
      const rows=window.__FIRE_LAST_ROWS;
      if(!rows) return showToast("æ²’æœ‰å¿«å– rowsï¼Œè«‹å…ˆæŒ‰ã€é›²ç«¯è®€å–ã€‘","warn");
      if(!document.getElementById('tbody') && typeof window.buildTable==='function'){ try{ buildTable(); }catch(e){} }
      if(typeof window.applyRows==='function'){ applyRows(rows); }
      showToast("å·²å¼·åˆ¶å¥—ç”¨é›²ç«¯ rows","ok");
    }catch(err){ showToast("å¼·åˆ¶å¥—ç”¨å¤±æ•—ï¼š"+err,"err"); }
  }, true);
  function hook(){
    const s=window.__fireSnap;
    if(!s || typeof s.loadFromFirestore!=="function") return false;
    const orig=s.loadFromFirestore;
    s.loadFromFirestore=async function(){
      const res=await orig.apply(this, arguments);
      const path="trafficSnapshots/"+(typeof getSnapId==='function'? getSnapId() : 'core-team-traffic-v3');
      try{ window.__showCloudDiag(window.__FIRE_LAST_ROWS, path); }catch(e){}
      return res;
    };
    // é¦–æ¬¡è‹¥å·²æœ‰ rows å°±é¡¯ç¤º
    try{ if(window.__FIRE_LAST_ROWS){ window.__showCloudDiag(window.__FIRE_LAST_ROWS, "trafficSnapshots/"+getSnapId()); } }catch(e){}
    return true;
  }
  let n=0, timer=setInterval(()=>{ n++; if(hook()||n>40) clearInterval(timer); }, 200);
})();
</script>
<!-- === /Cloud Debug Panel === -->

</body>
</html>
