<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Firestore 讀取健檢</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1020; color:#dbeafe; padding:24px}
    .card{max-width:860px;margin:0 auto;background:#0f172a;border:1px solid #334155;border-radius:14px;padding:18px 20px;
      box-shadow:0 8px 28px rgba(0,0,0,.35)}
    h1{font-size:20px;margin:0 0 12px;color:#93c5fd}
    pre{background:#0a1222;border-radius:10px;padding:12px;overflow:auto;max-height:320px}
    .ok{color:#10b981}.warn{color:#f59e0b}.err{color:#ef4444}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0}
    label{width:160px;opacity:.85}
    input{flex:1;background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:6px 10px}
    button{background:#1d4ed8;color:#fff;border:none;border-radius:10px;padding:8px 14px;cursor:pointer}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <div class="card">
    <h1>Firestore 讀取健檢（GitHub Pages 專用）</h1>
    <div class="row"><label>Collection / Doc</label><input id="path" value="trafficSnapshots/core-team-traffic-v3"></div>
    <div class="row"><button id="btn">測試讀取</button> <span id="status" class="muted">尚未測試</span></div>
    <pre id="log">log...</pre>
  </div>

  <!-- Firebase compat CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script>
    const cfg = {
      apiKey: "AIzaSyDDZYbqfz-A5BcpKmO_TO8ot5AAp4bUeTE",
      authDomain: "bni-info-meeting.firebaseapp.com",
      projectId: "bni-info-meeting",
      storageBucket: "bni-info-meeting.firebasestorage.app",
      messagingSenderId: "943878549247",
      appId: "1:943878549247:web:a1ab47cbf589e3b1ab26ca",
      measurementId: "G-P2QGJ52GKW"
    };
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    const db = firebase.firestore();

    function log(...args){
      const el = document.getElementById('log');
      el.textContent += "\n" + args.map(a => typeof a==='string'? a : JSON.stringify(a,null,2)).join(' ');
      el.scrollTop = el.scrollHeight;
    }
    function setStatus(text, cls){ const s=document.getElementById('status'); s.className=cls||''; s.textContent=text; }

    document.getElementById('btn').addEventListener('click', async ()=>{
      const p = document.getElementById('path').value.trim();
      setStatus('讀取中…','muted'); document.getElementById('log').textContent = '';
      try{
        const [coll, docId] = p.split('/');
        const snap = await db.collection(coll).doc(docId).get();
        if(!snap.exists){ setStatus('⚠️ 找不到文件','warn'); log('exists = false'); return; }
        setStatus('✅ 讀取成功','ok');
        const data = snap.data()||{};
        log('keys:', Object.keys(data));
        if(Array.isArray(data.rows)){ log('rows.length =', data.rows.length); log('first row =', data.rows[0]); }
      }catch(err){
        setStatus('❌ 讀取失敗','err');
        log('error name=', err.name, ' code=', err.code, ' message=', err.message);
        if (err.code === 'permission-denied'){ 
          log('👉 可能是 Firestore 規則擋住，請暫時設 allow read: if true;');
        }
        if ((err.message||'').includes('AppCheck')){
          log('👉 可能是 App Check 擋住；請關閉強制或配置 reCAPTCHA site key。');
        }
      }
    });
  </script>
</body>
</html>
