<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>BNI æ ¸å¿ƒåœ˜æˆå“¡ï¼ˆé›²ç«¯ï¼‹RWDï¼‹å¯†ç¢¼ï¼‰</title>
  <style>
    :root{ --bg:#0f1115; --surface:#151821; --muted:#9aa0a6; --text:#e8eaed; --accent:#facc15; --border:#262b3a;
           --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --chip:#0b1220; --chip-b:#314d7a;}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
    .wrap{max-width:1220px;margin:22px auto;padding:0 14px}
    h1{font-size:20px;margin:0 0 10px}
    .sub{color:var(--muted);font-size:12px;margin-bottom:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 14px}
    .tag{padding:4px 9px;border-radius:999px;border:1px solid var(--border);color:var(--muted);background:#10131a}
    button{background:#1b2030;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
    button:hover{background:#20273a}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .badge{font-size:11px;background:#111827;border:1px solid var(--border);color:#cbd5e1;padding:3px 6px;border-radius:8px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 22px #00000040;overflow:hidden}
    .table-wrap{overflow:auto;border-top:1px solid var(--border)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,#1b1f2b,#161a26);z-index:3}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:center;white-space:nowrap}
    tbody tr:hover{background:#171b27}
    #grid th:first-child,#grid td:first-child{position:sticky;left:0;background:inherit;z-index:2}
    #grid th:nth-child(2),#grid td:nth-child(2){position:sticky;left:60px;background:inherit;z-index:2}
    #grid th:nth-child(3),#grid td:nth-child(3){position:sticky;left:210px;background:inherit;z-index:2}
    #grid th:nth-child(1){min-width:60px}
    #grid th:nth-child(2){min-width:150px}
    #grid th:nth-child(3){min-width:250px;text-align:left}
    .date-head{min-width:120px}
    .date-chip{display:inline-block;background:var(--accent);color:#111;padding:4px 10px;border-radius:8px;font-weight:700}
    .cell-wrap{display:flex;flex-direction:column;align-items:center;gap:6px}
    .status{display:inline-grid;place-items:center;width:32px;height:32px;border-radius:999px;border:1px solid var(--border);background:#0f1320;cursor:pointer;user-select:none}
    .status[aria-label="ğŸŸ¢"]{background:rgba(22,163,74,.14);border-color:rgba(22,163,74,.6)}
    .status[aria-label="ğŸŸ¡"]{background:rgba(202,138,4,.14);border-color:rgba(202,138,4,.6)}
    .status[aria-label="ğŸ”´"]{background:rgba(220,38,38,.14);border-color:rgba(220,38,38,.6)}
    .guest-wrap{display:flex;align-items:center;gap:4px}
    .guest-step,.guest-zero{font-size:11px;line-height:1;padding:3px 6px;border-radius:8px;border:1px solid var(--border);background:#1a2133;color:#dbeafe;cursor:pointer}
    .guest-input{width:40px;text-align:center;background:#0c111c;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:3px 4px}
    .pair-btn{font-size:11px;line-height:1;padding:3px 6px;border-radius:8px;border:1px solid var(--border);background:#1a2133;color:#cfe1ff;cursor:pointer}
    .o2o-pill{font-size:11px;padding:2px 6px;border:1px solid var(--chip-b);border-radius:999px;background:var(--chip);color:#cfe1ff}
    .totals{font-size:12px;display:flex;gap:8px;justify-content:center;color:#cbd5e1}
    .footer{color:var(--muted);padding:12px 16px}
    input[type="search"]{background:#0c111c;color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;min-width:220px;margin-left:auto}
    /* Matrix */
    .matrix-card h2{font-size:16px;margin:14px}
    #matrixWrap{overflow:auto;border-top:1px solid var(--border)}
    #matrix{border-collapse:separate;border-spacing:0;width:100%}
    #matrix th,#matrix td{border-bottom:1px solid var(--border);border-right:1px solid var(--border);padding:8px 10px;text-align:center;white-space:nowrap}
    #matrix th:first-child,#matrix td:first-child{position:sticky;left:0;background:#141926;z-index:1;text-align:left}
    #matrix thead th{position:sticky;top:0;background:#141926;z-index:2}
    #matrix td.diag{background:repeating-linear-gradient(135deg, #1d2436, #1d2436 6px, #162033 6px, #162033 12px)}
    #matrix td.lit{background:#0f1b31}
    #matrix td:hover{outline:2px solid #3b82f6}
    .hint{font-size:12px;color:#93a4c4;margin:8px 0 0 2px}
    /* RWD helpers */
    :root{ --rwd-zoom:1 }
    #rwd_wrap{ transform: scale(var(--rwd-zoom)); transform-origin: top left; }
    .rwd-scroll{ overflow:auto; -webkit-overflow-scrolling: touch; }
    body.rwd-mobile{ font-size: clamp(15px, 1.9vw + 0.5rem, 18px); line-height: 1.35; }
    body.rwd-mobile button, body.rwd-mobile .btn{ min-height: 38px; font-size: 16px }
    #rwd_fab_bar{ position:fixed; right:14px; bottom:18px; z-index:2147483646; display:flex; flex-direction:column; gap:10px }
    #rwd_fab_bar .fab{ width:42px; height:42px; border-radius:9999px; display:flex; align-items:center; justify-content:center;
      background:#0a1222; color:#cfe1ff; border:1px solid #314d7a; box-shadow:0 4px 12px rgba(0,0,0,.35); cursor:pointer; }
    #rwd_zoom_card{ position:fixed; right:66px; bottom:18px; background:#0a1222; color:#cfe1ff; border:1px solid #314d7a;
      padding:8px 10px; border-radius:10px; display:none; gap:8px; align-items:center; box-shadow:0 8px 24px rgba(0,0,0,.35); z-index:2147483646 }
    #rwd_zoom_card input[type="range"]{ width:160px }
    /* Lock banner */
    #lockBanner{position:sticky;top:0;z-index:5;display:none;padding:8px 10px;margin-bottom:8px;border:1px dashed #475569;border-radius:10px;background:#0b1220;color:#cfe1ff}
    /* Password modal */
    #pwdModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
    #pwdBox{background:#121726;border:1px solid var(--border);border-radius:12px;padding:16px;min-width:min(90vw,360px)}
    #pwdBox h3{margin:0 0 8px}
    #pwdBox input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0c111c;color:#e5e7eb}
    #pwdBox .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    #pwdBox button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#1a2133;color:#cfe1ff}
  
/* --- Mobile-friendly sticky tweaks (avoid name overlay) --- */
#grid th:nth-child(3), #grid td:nth-child(3){ box-shadow: 8px 0 12px -8px rgba(0,0,0,.55) inset; }
@media (max-width: 820px){
  /* On small screens, unstick name & profession to prevent overlay on data cells */
  #grid th:nth-child(2), #grid td:nth-child(2),
  #grid th:nth-child(3), #grid td:nth-child(3){
    position: static !important;
    left: auto !important;
    z-index: auto !important;
    box-shadow: none !important;
  }
  /* Keep only the first index column sticky (small) */
  #grid th:first-child, #grid td:first-child{
    position: sticky !important;
    left: 0 !important;
    z-index: 2 !important;
  }
}


/* Sticky-names mode (mobile-friendly) */
body.sticky-names #grid th:nth-child(2), 
body.sticky-names #grid td:nth-child(2),
body.sticky-names #grid th:nth-child(3), 
body.sticky-names #grid td:nth-child(3){
  position: sticky !important;
  left: auto !important;
  z-index: 2 !important;
}
/* Position the second & third columns next to the first sticky col */
body.sticky-names #grid th:nth-child(2), body.sticky-names #grid td:nth-child(2){ left: var(--sticky1, 60px) !important; }
body.sticky-names #grid th:nth-child(3), body.sticky-names #grid td:nth-child(3){ left: calc(var(--sticky1, 60px) + var(--sticky2, 150px)) !important; }
/* Add left padding to scrollable area so data doesn't hide under sticky columns */

/* Floating row name chip (shown when sticky is OFF and user touches table) */
#rowChip{
  position: fixed; left: 10px; bottom: 70px; z-index: 2147483001;
  background: #0a1222; color: #cfe1ff; border:1px solid #314d7a; border-radius: 999px;
  padding: 6px 10px; font-size: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.35);
  display:none; pointer-events:none; max-width: 60vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
@media (min-width: 821px){
  /* Only use the chip behavior on small screens */
  #rowChip{ display:none !important; }
}


/* Improve contrast in pairing dialog list */
#pairDialog { color: #e8eaed; }
#pairDialog label { color: #e8eaed; }
#pairDialog input[type="checkbox"] { accent-color: #60a5fa; }
#pairDialog #pairList { background:#0c111c; }


/* Fix sticky layering and visual when locking name columns */
body.sticky-names #grid th:nth-child(2), 
body.sticky-names #grid td:nth-child(2),
body.sticky-names #grid th:nth-child(3), 
body.sticky-names #grid td:nth-child(3){
  background: #161a26 !important;
  z-index: 5 !important;
}
/* subtle divider to the right of col 3 when locked */
body.sticky-names #grid th:nth-child(3), 
body.sticky-names #grid td:nth-child(3){
  box-shadow: 8px 0 12px -8px rgba(0,0,0,.55) inset;
}


/* æœªåŠ å…¥å‰çš„ç°éšç¦ç”¨ç‹€æ…‹ */
.prejoin { opacity:.45; filter:saturate(0.2); pointer-events:none }
.prejoin .status, .prejoin .guest-step, .prejoin .guest-zero, .prejoin .guest-input, .prejoin .pair-btn { pointer-events:none }
.name-badge { font-size:10px; color:#facc15; border:1px solid #4b5563; padding:1px 6px; border-radius:999px; margin-left:6px; background:#111827 }


/* === Pair dialog: force white names & better contrast === */
#pairDialog { color:#e8eaed; }
#pairDialog label { color:#e8eaed !important; }
#pairDialog #pairList { background:#0c111c; }
#pairDialog input[type="checkbox"]{ accent-color:#60a5fa; }


/* === Join dialog: force white text for readability === */
#joinDialog { color:#e8eaed; }
#joinDialog * { color:#e8eaed; }
#joinDialog #joinList { background:#0c111c; }
#joinDialog select { background:#0c111c; border:1px solid #334155; color:#e8eaed; border-radius:8px; padding:6px; }
#joinDialog option { color:#e8eaed; background:#0c111c; }


/* å¼·åŒ–ï¼šæœªè§£é–æ™‚ä¹Ÿä¿æŒäº®åº¦ */
.status[disabled]{ opacity:1 !important; }
/* ä¹Ÿè®“ o2o-pill åœ¨å”¯è®€æ™‚æ¸…æ¥š */
.o2o-pill[disabled]{ opacity:1 !important; }
</style>
</head>
<body>
<div class="wrap" id="app">
  <h1>æ ¸å¿ƒåœ˜æˆå“¡ï¼10/01 ~ 11/05ï¼ˆğŸŸ¢å‡ºå¸­ï½œğŸŸ¡é²åˆ°ï½œğŸ”´ç¼ºå¸­ï¼‰ <span id="modeBadge" class="badge" title="æœªè§£é–æ™‚åƒ…èƒ½é›²ç«¯è®€å–">Read-only</span></h1>
  <div class="sub">æ—¥æœŸï¼š10/01ã€10/08ã€10/15ã€10/22ã€10/29ã€11/05 ï½œ ä¾†è³“ï¼š- / + / ç›´æ¥è¼¸å…¥ / 0 æ­¸é›¶ ï½œ ä¸€å°ä¸€ï¼šæŒ‰ã€Œé…å°ã€å‹¾é¸å°è±¡</div>

  <div id="lockBanner">ğŸ”’ ç›®å‰ç‚ºã€Œé›²ç«¯è®€å–æ¨¡å¼ã€ã€‚è‹¥éœ€ç·¨è¼¯ï¼Œè«‹è¼¸å…¥å¯†ç¢¼è§£é–ã€‚</div>

  <div class="toolbar">
    <button id="unlockBtn">è§£é–ï¼ˆå¯†ç¢¼ï¼‰</button>
    <button id="cloudSave">é›²ç«¯å„²å­˜</button>
    <button id="cloudLoad">é›²ç«¯è®€å–</button>
    <button id="toggleSticky" class="badge" title="è¡Œå‹•è£ç½®å»ºè­°é–‹å•Ÿ">é–å®šå§“åæ¬„ï¼šé—œ</button>
    <button id="importBtn">åŒ¯å…¥æˆå“¡</button>
    <button id="addBtn">æ–°å¢æˆå“¡</button>
    <button id="joinBtn">åŠ å…¥æ—¥è¨­å®š</button>
    <button id="csvBtn">åŒ¯å‡ºCSV</button>
    <button id="printBtn">åˆ—å°</button>
    <input class="search" id="q" placeholder="å¿«é€Ÿæœå°‹å§“å/å°ˆæ¥­åˆ¥â€¦" type="search"/>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table id="grid">
        <thead>
          <tr>
            <th>#</th>
            <th>å§“å</th>
            <th>å°ˆæ¥­åˆ¥</th>
            <th class="date-head"><span class="date-chip">10/01</span><div class="totals" data-date="2025-10-01"></div></th>
            <th class="date-head"><span class="date-chip">10/08</span><div class="totals" data-date="2025-10-08"></div></th>
            <th class="date-head"><span class="date-chip">10/15</span><div class="totals" data-date="2025-10-15"></div></th>
            <th class="date-head"><span class="date-chip">10/22</span><div class="totals" data-date="2025-10-22"></div></th>
            <th class="date-head"><span class="date-chip">10/29</span><div class="totals" data-date="2025-10-29"></div></th>
            <th class="date-head"><span class="date-chip">11/05</span><div class="totals" data-date="2025-11-05"></div></th>
            <th>å‡ºå¸­ç‡</th>
            <th>ä¾†è³“ç¸½æ•¸</th>
            <th>å¸¶ä¾†è³“æ¯”ç‡</th>
            <th>ä¸€å°ä¸€æ¬¡æ•¸</th>
            <th>ä¸€å°ä¸€æ¯”ç‡</th>
            <th>ç¸½é«”ç¸¾æ•ˆ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="footer">é»åœ“é»åˆ‡æ›ï¼šğŸŸ¢ â†’ ğŸŸ¡ â†’ ğŸ”´ â†’ ç©ºç™½ã€‚æ¯æ ¼å¯ç›´æ¥è¼¸å…¥ä¾†è³“æ•¸ï¼›æŒ‰ã€Œé…å°ã€å‹¾é¸å°è±¡ï¼Œä¸‹æ–¹çŸ©é™£æœƒä¾æ—¥æœŸå»é‡è¨ˆç®—ã€‚</div>
  </div>

  <div class="card matrix-card" id="o2oMatrixCard" style="margin-top:16px;">
    <h2>ä¸€å°ä¸€é…å°çŸ©é™£</h2>
    <div id="matrixWrap"><table id="matrix"></table></div>
    <div class="footer" style="color:#9aa0a6;">æ»‘é¼ ç§»åˆ°æ•¸å­—å¯çœ‹ç•¶å¤©æ—¥æœŸï¼›æ–œç·šç‚ºæœ¬äººï¼›åŒä¸€å¤©åŒä¸€çµ„é…å°åªç®—ä¸€æ¬¡ã€‚</div>
  </div>
  <div class="hint">RWDï¼šå³ä¸‹è§’ ğŸ“± åˆ‡æ›æ‰‹æ©Ÿç‰ˆã€ğŸ” èª¿æ•´ç¸®æ”¾ï¼ˆæœƒè¨˜æ†¶ï¼‰ã€‚</div>
</div>

<!-- Password Modal -->
<div id="pwdModal" style="display:none">
  <div id="pwdBox">
    <h3>è¼¸å…¥å¯†ç¢¼ä»¥è§£é–ç·¨è¼¯</h3>
    <input id="pwdInput" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
    <div class="actions">
      <button id="onlyRead">åªç”¨é›²ç«¯è®€å–</button>
      <button id="pwdOK">è§£é–</button>
    </div>
  </div>
</div>

<!-- åŒ¯å…¥å°è©±æ¡† -->
<dialog id="importDialog">
  <form method="dialog" style="min-width:min(720px,90vw);background:#151a26;border:1px solid var(--border);border-radius:12px;padding:16px;">
    <h3 style="margin:0 0 8px;">åŒ¯å…¥æˆå“¡ï¼ˆæ¯åˆ—ï¼šç·¨è™Ÿ,å§“å,å°ˆæ¥­åˆ¥ï¼‰</h3>
    <textarea id="importText" rows="10" style="width:100%;background:#0c111c;color:#eee;border:1px solid var(--border);border-radius:8px;padding:8px;white-space:pre;"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button value="cancel">å–æ¶ˆ</button>
      <button id="doImport" value="default">åŒ¯å…¥</button>
    </div>
  </form>
</dialog>


<!-- æ–°å¢æˆå“¡å°è©±æ¡† -->
<dialog id="addMemberDialog">
  <form method="dialog" style="min-width:min(560px,90vw);background:#151a26;border:1px solid var(--border);border-radius:12px;padding:16px;">
    <h3 style="margin:0 0 8px;">æ–°å¢æˆå“¡</h3>
    <div style="display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;">
      <label>ç·¨è™Ÿï¼ˆè‡ªå‹•ï¼‰</label>
      <input id="addId" type="number" readonly style="background:#0c111c;color:#e8eaed;border:1px solid var(--border);border-radius:8px;padding:8px;">
      <label>å§“å</label>
      <input id="addName" type="text" placeholder="å¿…å¡«" style="background:#0c111c;color:#e8eaed;border:1px solid var(--border);border-radius:8px;padding:8px;">
      <label>å°ˆæ¥­åˆ¥</label>
      <input id="addProf" type="text" placeholder="å¿…å¡«" style="background:#0c111c;color:#e8eaed;border:1px solid var(--border);border-radius:8px;padding:8px;">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button value="cancel">å–æ¶ˆ</button>
      <button id="addOK" value="default">åŠ å…¥</button>
    </div>
  </form>
</dialog>

<!-- é…å°å°è©±æ¡† -->
<dialog id="pairDialog">
  <form method="dialog" style="min-width:min(560px,92vw);background:#151a26;border:1px solid var(--border);border-radius:12px;padding:16px;">
    <h3 id="pairTitle" style="margin:0 0 8px;">é¸æ“‡ä¸€å°ä¸€å°è±¡</h3>
    <div id="pairList" style="max-height:52vh;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px;background:#0c111c"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button value="cancel">å–æ¶ˆ</button>
      <button id="pairOK" value="default">ç¢ºå®š</button>
    </div>
  </form>
</dialog>

<script>
// === å¸¸æ•¸ ===
const DATES = ["10/01","10/08","10/15","10/22","10/29","11/05"];
const DATE_KEYS = ["2025-10-01","2025-10-08","2025-10-15","2025-10-22","2025-10-29","2025-11-05"];
const MEMBERS_KEY = "core-team-members-2025-10";



function ensureMember14(){
  try{
    if(!Array.isArray(MEMBERS)) MEMBERS = [];
    var exists = MEMBERS.some(function(m){ return (Number(m.id)===14) || (m && m.name==="æ±Ÿæ˜é§¿"); });
    if(!exists){
      MEMBERS.push({ id:14, name:"æ±Ÿæ˜é§¿", profession:"é«˜ç©ºæ¨¹æœ¨å·¥ç¨‹", joinDate: (DATE_KEYS && DATE_KEYS[0]) });
      MEMBERS.sort(function(a,b){ return (Number(a.id)||0) - (Number(b.id)||0); });
      try{ localStorage.setItem(MEMBERS_KEY, JSON.stringify(MEMBERS)); }catch(e){}
    }
  }catch(e){}
}

let MEMBERS = [
  { id:1,  name:"å¾åœ‹è¯", profession:"ä¸­è—¥åŒ…è£è¨­å‚™è²·è³£æ¥­" },
  { id:2,  name:"å³å† ç’‹", profession:"ç†è²¡è¦åŠƒä¿éšªæ¥­" },
  { id:3,  name:"é˜å§µç¾š", profession:"åœŸåœ°é–‹ç™¼æ¥­" },
  { id:4,  name:"æå®‡æ™´", profession:"å¸‚èª¿æ¥­" },
  { id:5,  name:"é™³æ¸…ç‰", profession:"èŒ¶è£½å“æ‰¹ç™¼é›¶å”®" },
  { id:6,  name:"æ—ä½‘å„’", profession:"è¸ç‰›é¤Šæ®–è²·è³£æ¥­" },
  { id:7,  name:"æ—å½¥å®", profession:"ç±³ç³§å•†" },
  { id:8,  name:"é™³å»ºå®", profession:"è»ŸåŒ…è£å®¢è£½åŒ–å·¥å» " },
  { id:9,  name:"æ±Ÿèª ä»²", profession:"æµ·è‹”æ‰¹ç™¼é›¶å”®" },
  { id:10, name:"ææœµå«»", profession:"å’–å•¡çƒ˜è±†æ¥­" },
  { id:11, name:"é¾æ˜†ç¿°", profession:"æ±½è»Šéè†œæ¥­" },
  { id:12, name:"å¾å­è¡¡", profession:"æ²¹å“å“ç‰Œå•†" },
  { id:13, name:"å³å…¸è“‰", profession:"æ°‘äº‹è¨´è¨Ÿå¾‹å¸«" },  { id:14, name:"æ±Ÿæ˜é§¿", profession:"é«˜ç©ºæ¨¹æœ¨å·¥ç¨‹" }

];

const tbody = document.getElementById('tbody');
let READ_ONLY = true;

// === UI helpers ===
function setReadOnly(ro){
  READ_ONLY = ro;
  const badge = document.getElementById('modeBadge');
  const banner = document.getElementById('lockBanner');
  badge.textContent = ro ? "Read-only" : "å·²è§£é–";
  badge.style.background = ro ? "#111827" : "#052e16";
  banner.style.display = ro ? "block" : "none";

  // Disable/enable controls
  document.getElementById('cloudSave').disabled = ro;
  document.getElementById('importBtn').disabled = ro;
  [...document.querySelectorAll('.status,.guest-step,.guest-zero,.guest-input,.pair-btn')].forEach(el=>{
    el.toggleAttribute('disabled', ro);
    if (el.classList.contains('guest-input')) el.readOnly = ro;
  });
}

const STATES=['','ğŸŸ¢','ğŸŸ¡','ğŸ”´'];
function statusCell(dataKey){
  const wrap = document.createElement('div'); wrap.className = 'cell-wrap';
  const btn = document.createElement('button'); btn.className = 'status'; btn.setAttribute('data-date', dataKey); btn.setAttribute('aria-label',''); btn.textContent = ''; btn.title='å·¦éµï¼šå‡ºå¸­/é²åˆ°/ç¼ºå¸­'; 
  btn.addEventListener('click', ()=>{ if(READ_ONLY) return; cycle(btn) });
  wrap.appendChild(btn);

  const gwrap = document.createElement('div'); gwrap.className='guest-wrap';
  const minus = document.createElement('button'); minus.type='button'; minus.className='guest-step'; minus.textContent='-';
  const input = document.createElement('input'); input.type='number'; input.className='guest-input'; input.min='0'; input.max='99'; input.value='0';
  const plus = document.createElement('button'); plus.type='button'; plus.className='guest-step'; plus.textContent='+';
  const zero = document.createElement('button'); zero.type='button'; zero.className='guest-zero'; zero.textContent='0'; zero.title='æ­¸é›¶';
  const clamp = ()=>{ let v=parseInt(input.value||'0'); if(isNaN(v)||v<0) v=0; if(v>99) v=99; input.value=String(v); };
  minus.addEventListener('click', ()=>{ if(READ_ONLY) return; input.value = String(Math.max(0, (parseInt(input.value||'0')||0)-1)); input.dispatchEvent(new Event('input')); });
  plus.addEventListener('click',  ()=>{ if(READ_ONLY) return; input.value = String(Math.min(99,(parseInt(input.value||'0')||0)+1)); input.dispatchEvent(new Event('input')); });
  zero.addEventListener('click',  ()=>{ if(READ_ONLY) return; input.value = '0'; input.dispatchEvent(new Event('input')); });
  input.addEventListener('input', ()=>{ if(READ_ONLY) return; clamp(); updateTotals(); });
  gwrap.append(minus,input,plus,zero);
  wrap.appendChild(gwrap);

  const pill = document.createElement('span'); pill.className='o2o-pill'; pill.textContent='ğŸ¤ 0'; pill.dataset.count='0';
  const pair = document.createElement('button'); pair.type='button'; pair.className='pair-btn'; pair.textContent='é…å°'; pair.dataset.partners='[]';
  pair.addEventListener('click',()=>{ if(READ_ONLY) return; openPairDialog(btn, pill) });
  wrap.append(pill, pair);
  return wrap;
}
function cycle(btn){ const cur=btn.getAttribute('aria-label')||''; const idx=STATES.indexOf(cur); const nxt=STATES[(idx+1)%STATES.length]; btn.setAttribute('aria-label',nxt); btn.textContent=nxt; updateTotals(); }

function buildTable(){
  tbody.innerHTML='';
  MEMBERS.forEach((m)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${m.id}</td><td>${m.name}</td><td>${m.profession}</td>`;
    DATE_KEYS.forEach(k=>{ const td=document.createElement('td'); td.appendChild(statusCell(k)); tr.appendChild(td); });
    for(let i=0;i<6;i++){ const td=document.createElement('td'); tr.appendChild(td); }
    tbody.appendChild(tr);
  });
  updateTotals();
  setReadOnly(READ_ONLY);
}

// === Pairing ===
const pairDialog=document.getElementById('pairDialog');
const pairList=document.getElementById('pairList');
const pairOK=document.getElementById('pairOK');
const pairTitle=document.getElementById('pairTitle');
let pairCtx=null;

function openPairDialog(btn, pill){
  const cell = btn.closest('td');
  const tr = cell.closest('tr'); const ri = [...tbody.children].indexOf(tr);
  const di = [...tr.children].indexOf(cell) - 3;
  pairCtx = { btn, pill, ri, di };
  pairTitle.textContent = `${MEMBERS[ri].name}ï¼${DATES[di]} çš„ä¸€å°ä¸€å°è±¡`;
  pairList.innerHTML='';
  MEMBERS.forEach((m,idx)=>{
    if(idx===ri) return;
    const row=document.createElement('label'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 4px';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.value=String(idx);
    row.append(cb, document.createTextNode(`${m.id}. ${m.name}ï½œ${m.profession}`));
    pairList.appendChild(row);
  });
  // å¥—å…¥å·²é¸
  try{
    const partners = JSON.parse(cell.querySelector('.pair-btn').dataset.partners||'[]');
    [...pairList.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{ cb.checked = partners.includes(parseInt(cb.value)); });
  }catch(e){}
  pairDialog.showModal();
}
pairOK?.addEventListener('click',()=>{
  if(!pairCtx) return;
  const {btn,pill,ri,di} = pairCtx;
  const cell = btn.closest('td');
  const chosen = [...pairList.querySelectorAll('input[type="checkbox"]')].filter(i=>i.checked).map(i=>parseInt(i.value));
  const pairBtn = cell.querySelector('.pair-btn'); pairBtn.dataset.partners = JSON.stringify(chosen);
  pill.dataset.count = String(chosen.length);
  pill.textContent = `ğŸ¤ ${chosen.length}`;
  updateTotals();
});

// === Snapshot / Apply ===
function snapshot(){
  const rows=[];
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
    const cells=tr.querySelectorAll('td');
    const row={ id: MEMBERS[ri].id };
    DATE_KEYS.forEach((k,di)=>{
      const cell=cells[3+di];
      const b=cell.querySelector('.status');
      const g=cell.querySelector('.guest-input');
      const p=cell.querySelector('.pair-btn');
      const pill=cell.querySelector('.o2o-pill');
      row[k]=b.getAttribute('aria-label')||'';
      row[k+'_g']=parseInt(g?.value||'0')||0;
      try{ row[k+'_p']=JSON.parse(p?.dataset.partners||'[]'); }catch(e){ row[k+'_p']=[]; }
      row[k+'_1on1']=parseInt(pill?.dataset.count||'0')||0;
    });
    rows.push(row);
  });
  return rows;
}
function applyRows(rows){
  if(!Array.isArray(rows)) return;
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
    const cells=tr.querySelectorAll('td');
    DATE_KEYS.forEach((k,di)=>{
      const cell=cells[3+di];
      const b=cell.querySelector('.status');
      const g=cell.querySelector('.guest-input');
      const p=cell.querySelector('.pair-btn');
      const pill=cell.querySelector('.o2o-pill');
      const v=rows[ri]?.[k]||''; b.setAttribute('aria-label',v); b.textContent=v;
      const gval=parseInt(rows[ri]?.[k+'_g'])||0; if(g) g.value=String(gval);
      const partners=Array.isArray(rows[ri]?.[k+'_p'])? rows[ri][k+'_p'] : []; p.dataset.partners = JSON.stringify(partners);
      const n = partners.length>0 ? partners.length : (parseInt(rows[ri]?.[k+'_1on1'])||0);
      pill.dataset.count = String(n); pill.textContent = `ğŸ¤ ${n}`;
    });
    fillRightSummary(tr,ri);
  });
  updateTotals();
}

// === Totals & Matrix ===
function updateTotals(){
  DATE_KEYS.forEach((k,di)=>{
    let g=0,y=0,r=0,guestSum=0;
    const seen=new Set();
    [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
      const cell=tr.querySelectorAll('td')[3+di];
      const v=cell.querySelector('.status').textContent;
      if(v==='ğŸŸ¢') g++; else if(v==='ğŸŸ¡') y++; else if(v==='ğŸ”´') r++;
      guestSum += parseInt(cell.querySelector('.guest-input')?.value||'0')||0;
      const partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]');
      partners.forEach(pj=>{
        const a=Math.min(ri,pj), b=Math.max(ri,pj);
        seen.add(`${a}-${b}`);
      });
    });
    const o2o = seen.size;
    const wrap=document.querySelector(`.totals[data-date="${k}"]`);
    wrap.innerHTML=`<span>ğŸŸ¢ ${g}</span> <span>ğŸŸ¡ ${y}</span> <span>ğŸ”´ ${r}</span> <span>ğŸ‘¥ ${guestSum}</span> <span>ğŸ¤ ${o2o}</span>`;
  });
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>fillRightSummary(tr,ri));
  buildMatrix();
}

function fillRightSummary(tr,ri){
  const cells=tr.querySelectorAll('td'); let present=0, guestCnt=0, guestDays=0, o2oSum=0, o2oDays=0;
  DATE_KEYS.forEach((k,di)=>{
    const cell=cells[3+di]; const v=cell.querySelector('.status').textContent;
    if(v==='ğŸŸ¢'||v==='ğŸŸ¡'){ present++; }
    const g=parseInt(cell.querySelector('.guest-input')?.value||'0')||0; guestCnt+=g; if(g>0 && (v==='ğŸŸ¢'||v==='ğŸŸ¡')) guestDays++;
    const partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]'); if((v==='ğŸŸ¢'||v==='ğŸŸ¡') && partners.length>0) o2oDays++; o2oSum+=partners.length;
  });
  const total=DATE_KEYS.length; const attRate= total? Math.round((present/total)*1000)/10 : 0; const guestRate= present? Math.round((guestDays/present)*1000)/10 : 0; const o2oRate= present? Math.round((o2oDays/present)*1000)/10 : 0; const perf=Math.round((0.5*attRate + 0.25*guestRate + 0.25*o2oRate)*10)/10; const base=3+DATE_KEYS.length; const vals=[attRate.toFixed(1)+'%', guestCnt, guestRate.toFixed(1)+'%', o2oSum, o2oRate.toFixed(1)+'%', perf.toFixed(1)+'%']; for(let i=0;i<6;i++){ const td=tr.querySelectorAll('td')[base+i]; td.textContent=vals[i]; td.className=['att-rate','guest-sum','guest-rate','o2o-sum','o2o-rate','perf-score'][i]; }
}

function buildMatrix(){
  const tbl=document.getElementById('matrix'); if(!tbl) return;
  // Build counts and detail dates
  const details = Array.from({length:MEMBERS.length},()=>Array(MEMBERS.length).fill(null).map(()=>new Set()));
  DATE_KEYS.forEach((k,di)=>{
    const seenDay = new Set();
    [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
      const cell=tr.querySelectorAll('td')[3+di];
      const partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]');
      partners.forEach(pj=>{
        const a=Math.min(ri,pj), b=Math.max(ri,pj);
        const key=`${a}-${b}`;
        if(!seenDay.has(key)){ seenDay.add(key); details[a][b].add(DATES[di]); details[b][a].add(DATES[di]); }
      });
    });
  });

  let html='<thead><tr><th>æˆå“¡</th>';
  MEMBERS.forEach(m=> html+=`<th>${m.name}</th>`);
  html+='</tr></thead><tbody>';
  MEMBERS.forEach((m,i)=>{
    html+=`<tr><th>${m.name}</th>`;
    MEMBERS.forEach((n,j)=>{
      if (i === j) { html += '<td class="diag"></td>'; }
      else {
        const cnt = details[i][j].size;
        const cls = cnt>0 ? ' class="lit"' : '';
        const tip = cnt>0 ? ` title="${[...details[i][j]].join('ã€')}"` : '';
        html += `<td${cls}${tip}>${cnt||''}</td>`;
      }
    });
    html+='</tr>';
  });
  html+='</tbody>';
  tbl.innerHTML=html;
}

// === Export / Print ===
function exportCSV(){
  const headers=['ç·¨è™Ÿ','å§“å','å°ˆæ¥­åˆ¥',...DATES,'å‡ºå¸­ç‡','ä¾†è³“ç¸½æ•¸','å¸¶ä¾†è³“æ¯”ç‡','ä¸€å°ä¸€æ¬¡æ•¸','ä¸€å°ä¸€æ¯”ç‡','ç¸½é«”ç¸¾æ•ˆ'];
  const lines=[headers.join(',')];
  [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
    const base=[MEMBERS[ri].id, MEMBERS[ri].name, MEMBERS[ri].profession.replaceAll(',','ï¼Œ')];
    const marks=DATE_KEYS.map((k,di)=>tr.querySelectorAll('td')[3+di].querySelector('.status').textContent);
    const rate=tr.querySelector('.att-rate')?.textContent||'';
    const gsum=tr.querySelector('.guest-sum')?.textContent||'';
    const grate=tr.querySelector('.guest-rate')?.textContent||'';
    const o2osum=tr.querySelector('.o2o-sum')?.textContent||'';
    const o2orate=tr.querySelector('.o2o-rate')?.textContent||'';
    const perf=tr.querySelector('.perf-score')?.textContent||'';
    lines.push([...base,...marks,rate,gsum,grate,o2osum,o2orate,perf].join(','));
  });
  const bom = String.fromCharCode(65279);
  const blob=new Blob([bom+lines.join('\\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='æ ¸å¿ƒåœ˜æˆå“¡_10-01_11-05.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function printPage(){ window.print(); }

// === Init ===
function init(){
  // Try restore members from localStorage
  try{ const m = JSON.parse(localStorage.getItem(MEMBERS_KEY)||'null'); if(Array.isArray(m) && m.length){ MEMBERS = m; } }catch(e){}
  buildTable();
  document.getElementById('csvBtn').addEventListener('click', exportCSV);
  document.getElementById('printBtn').addEventListener('click', printPage);
  document.getElementById('importBtn').addEventListener('click',()=>{
    if(READ_ONLY) return;
    const dlg = document.getElementById('importDialog');
    const ta = document.getElementById('importText');
    ta.value = MEMBERS.map(m=>`${m.id},${m.name},${m.profession}`).join('\\n');
    dlg.showModal();
  });
  document.getElementById('doImport').addEventListener('click',()=>{
    if(READ_ONLY) return;
    const ta = document.getElementById('importText');
    const lines=ta.value.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
    const parsed=[];
    for(const ln of lines){
      const parts=ln.split(/\\t|\\s*,\\s*/);
      if(parts.length>=3){ const id=Number(parts[0])||parsed.length+1; parsed.push({id,name:parts[1],profession:parts.slice(2).join(' ')}); }
    }
    if(parsed.length){ MEMBERS=parsed; localStorage.setItem(MEMBERS_KEY, JSON.stringify(MEMBERS)); buildTable(); }
  });

  // Search
  document.getElementById('q').addEventListener('input', (e)=>{
    const term=e.target.value.trim();
    [...tbody.querySelectorAll('tr')].forEach((tr,ri)=>{
      const hit=!term || (MEMBERS[ri]?.name||'').includes(term) || (MEMBERS[ri]?.profession||'').includes(term);
      tr.style.display=hit? '':'none';
    });
  });

  // Password gate
  const modal = document.getElementById('pwdModal');
  const onlyRead = document.getElementById('onlyRead');
  const ok = document.getElementById('pwdOK');
  const input = document.getElementById('pwdInput');
  modal.style.display='flex';
  onlyRead.onclick = ()=>{ modal.style.display='none'; setReadOnly(true); };
  ok.onclick = ()=>{
    if(input.value === '2614'){ modal.style.display='none'; setReadOnly(false); }
    else { alert('å¯†ç¢¼éŒ¯èª¤'); }
  };
  document.getElementById('unlockBtn').onclick = ()=>{ modal.style.display='flex'; input.value=''; input.focus(); };
}

init();
</script>

<!-- Firebaseï¼ˆapp+firestore compatï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// === Firestore Save/Load ===
(function(){
  const firebaseConfig = {
    apiKey: "AIzaSyDDZYbqfz-A5BcpKmO_TO8ot5AAp4bUeTE",
    authDomain: "bni-info-meeting.firebaseapp.com",
    projectId: "bni-info-meeting",
    storageBucket: "bni-info-meeting.firebasestorage.app",
    messagingSenderId: "943878549247",
    appId: "1:943878549247:web:a1ab47cbf589e3b1ab26ca",
    measurementId: "G-P2QGJ52GKW"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  const db = firebase.firestore();
  const COL = "trafficSnapshots";
  const DOC = "core-team-traffic-v3";
  const docRef = db.collection(COL).doc(DOC);

  async function saveToFirestore(){
    if(READ_ONLY){ alert('ğŸ”’ ç›®å‰ç‚ºè®€å–æ¨¡å¼ï¼Œè«‹å…ˆè§£é–'); return; }
    const rows = snapshot();
    const data = { rows, members: MEMBERS, dateKeys: DATE_KEYS, updatedAt: new Date().toISOString() };
    await docRef.set(data);
    alert("âœ… å·²å¯«å…¥é›²ç«¯");
  }
  async function loadFromFirestore(){
    const snap = await docRef.get();
    if(!snap.exists){ alert("âš ï¸ é›²ç«¯å°šç„¡è³‡æ–™"); return; }
    const data = snap.data() || {};
    if (Array.isArray(data.members) && data.members.length){ MEMBERS = data.members; }
    ensureMember14();
    buildTable();
    if (Array.isArray(data.rows)){ applyRows(data.rows); }
    alert("âœ… å·²å¾é›²ç«¯è®€å›");
  }

  window.saveToFirestore = saveToFirestore;
  window.loadFromFirestore = loadFromFirestore;

  document.getElementById('cloudSave').addEventListener('click', saveToFirestore);
  document.getElementById('cloudLoad').addEventListener('click', loadFromFirestore);
})();
</script>

<!-- RWD toggles -->
<div id="rwd_fab_bar" aria-label="RWD tools">
  <div id="rwd_fab_mobile" class="fab" title="æ‰‹æ©Ÿç‰ˆåˆ‡æ›">ğŸ“±</div>
  <div id="rwd_fab_zoom" class="fab" title="ç¸®æ”¾">ğŸ”</div>
</div>
<div id="rwd_zoom_card" role="dialog" aria-label="ç¸®æ”¾èª¿æ•´">
  <span>ç¸®æ”¾</span>
  <input id="rwd_zoom_range" type="range" min="0.75" max="1.4" step="0.05" value="1" />
  <span id="rwd_zoom_val">100%</span>
</div>
<script>
(function(){
  // Wrap content for zoom scaling
  try{
    var app = document.getElementById('app');
    var wrap = document.createElement('div'); wrap.id='rwd_wrap';
    var sc = document.createElement('div'); sc.className='rwd-scroll';
    while(app.firstChild){ sc.appendChild(app.firstChild); }
    wrap.appendChild(sc); app.appendChild(wrap);
  }catch(e){}

  var body = document.body;
  var fabM = document.getElementById('rwd_fab_mobile');
  var fabZ = document.getElementById('rwd_fab_zoom');
  var card = document.getElementById('rwd_zoom_card');
  var range = document.getElementById('rwd_zoom_range');
  var val = document.getElementById('rwd_zoom_val');

  function setZoom(z){
    z = Math.max(0.6, Math.min(1.6, z||1));
    document.documentElement.style.setProperty('--rwd-zoom', z);
    if(val) val.textContent = Math.round(z*100) + '%';
    try{ localStorage.setItem('rwd_zoom', String(z)); }catch(e){}
  }
  function setMobile(on){
    if(on){ body.classList.add('rwd-mobile'); }
    else{ body.classList.remove('rwd-mobile'); }
    try{ localStorage.setItem('rwd_mobile', on?'1':'0'); }catch(e){}
  }
  try{
    var z = parseFloat(localStorage.getItem('rwd_zoom')||'1'); if(!isNaN(z)){ setZoom(z); if(range) range.value = z; }
    var m = localStorage.getItem('rwd_mobile'); if(m!==null){ setMobile(m==='1'); }
    else if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches){ setMobile(true); }
  }catch(e){ setZoom(1); }

  if(fabM){ fabM.addEventListener('click', function(){ setMobile(!body.classList.contains('rwd-mobile')); }); }
  if(fabZ){ fabZ.addEventListener('click', function(){ if(!card) return; var show = card.style.display !== 'flex'; card.style.display = show ? 'flex' : 'none'; }); }
  if(range){ range.addEventListener('input', function(){ setZoom(parseFloat(range.value||'1')); }); }
  document.addEventListener('click', function(ev){ if(card && !card.contains(ev.target) && ev.target !== fabZ){ card.style.display='none'; } }, true);
})();
</script>

<div id="rowChip" aria-hidden="true"></div>

<script>
(function(){
  var stickyOn = false;
  var btn = document.getElementById('toggleSticky');
  var chip = document.getElementById('rowChip');
  var grid = document.getElementById('grid');
  var tbody = document.getElementById('tbody');

  function measureFrozen(){
    try{
      var th1 = grid.querySelector('thead th:nth-child(1)');
      var th2 = grid.querySelector('thead th:nth-child(2)');
      var th3 = grid.querySelector('thead th:nth-child(3)');
      var w1 = (th1 && th1.getBoundingClientRect().width) || 60;
      var w2 = (th2 && th2.getBoundingClientRect().width) || 150;
      var w3 = (th3 && th3.getBoundingClientRect().width) || 250;
      document.documentElement.style.setProperty('--sticky1', w1 + 'px');
      document.documentElement.style.setProperty('--sticky2', w2 + 'px');
      document.documentElement.style.setProperty('--sticky3', w3 + 'px');
      document.documentElement.style.setProperty('--frozenW', (w1 + w2 + w3) + 'px');
    }catch(e){}
  }

  function setSticky(on){
    stickyOn = !!on;
    document.body.classList.toggle('sticky-names', stickyOn);
    if (btn) btn.textContent = 'é–å®šå§“åæ¬„ï¼š' + (stickyOn ? 'é–‹' : 'é—œ');
    measureFrozen();
  }

  if (btn){
    btn.addEventListener('click', function(){ setSticky(!stickyOn); });
  }

  // Auto enable sticky on small screens if user prefers (store preference)
  try{
    var pref = localStorage.getItem('pref_sticky_names');
    if (pref !== null){ setSticky(pref === '1'); }
    else { setSticky(false); } // default off per your last request
    // Save preference on change
    btn && btn.addEventListener('click', function(){
      try{ localStorage.setItem('pref_sticky_names', stickyOn ? '1' : '0'); }catch(e){}
    });
  }catch(e){ setSticky(false); }

  // Re-measure on resize or after table rebuilds (expose a hook)
  window.addEventListener('resize', measureFrozen);
  var _buildTable = window.buildTable;
  window.buildTable = function(){ if (typeof _buildTable === 'function') _buildTable(); setTimeout(measureFrozen, 0); };

  // Touch-following row chip when sticky is OFF
  function rowFromEvent(ev){
    var t = ev.touches && ev.touches[0];
    if (!t) return null;
    var el = document.elementFromPoint(t.clientX, t.clientY);
    if (!el) return null;
    var tr = el.closest && el.closest('#tbody tr');
    return tr;
  }
  function nameForRow(tr){
    if(!tr) return '';
    var tds = tr.querySelectorAll('td');
    var name = (tds[1] && tds[1].textContent) || '';
    var prof = (tds[2] && tds[2].textContent) || '';
    return (name + (prof ? 'ï½œ' + prof : '')).trim();
  }

  function showChip(text){
    if (!chip) return;
    chip.textContent = text || '';
    chip.style.display = text ? 'inline-block' : 'none';
  }

  var wrap = document.querySelector('.table-wrap');
  if (wrap){
    var active = false;
    wrap.addEventListener('touchstart', function(ev){
      if (stickyOn) return; // no chip if sticky is on
      active = true;
      var tr = rowFromEvent(ev);
      showChip(nameForRow(tr));
    }, {passive: true});
    wrap.addEventListener('touchmove', function(ev){
      if (!active || stickyOn) return;
      var tr = rowFromEvent(ev);
      showChip(nameForRow(tr));
    }, {passive: true});
    ['touchend','touchcancel'].forEach(function(tp){
      wrap.addEventListener(tp, function(){ active = false; showChip(''); }, {passive: true});
    });
  }

  // Initial measure
  setTimeout(measureFrozen, 0);
})();
</script>


<!-- åŠ å…¥æ—¥è¨­å®šå°è©±æ¡† -->
<dialog id="joinDialog">
  <form method="dialog" style="min-width:min(720px,92vw);background:#151a26;border:1px solid #262b3a;border-radius:12px;padding:16px;">
    <h3 style="margin:0 0 8px;">è¨­å®šæˆå“¡åŠ å…¥æ—¥æœŸ</h3>
    <div id="joinList" style="max-height:52vh;overflow:auto;border:1px solid #262b3a;border-radius:8px;padding:8px;background:#0c111c"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button value="cancel">å–æ¶ˆ</button>
      <button id="joinOK" value="default">å„²å­˜</button>
    </div>
  </form>
</dialog>


<script>
// === åŠ å…¥æ—¥æœŸï¼šæ ¸å¿ƒé‚è¼¯ ===
// è‹¥ç¼ºå°‘ joinDateï¼Œé è¨­ç‚ºæœ€æ—©ä¸€æ—¥ï¼›ç¤ºç¯„ï¼šæˆå“¡ 13 å¾ 10/08 åŠ å…¥
(function(){
  function ensureJoinDates(){
    MEMBERS.forEach(function(m,i){
      if(!m.joinDate){ m.joinDate = DATE_KEYS[0]; }
    });
    // é è¨­æŠŠ ID=13 çš„åŠ å…¥æ—¥æ”¹ç‚º 10/08ï¼ˆå¦‚éœ€èª¿æ•´ï¼Œå¯åœ¨åŠ å…¥æ—¥è¨­å®šä¸­ä¿®æ”¹ï¼‰
    var m13 = MEMBERS.find(m=>m.id===13);
    if(m13 && !m13._patchedOnce){ m13.joinDate = "2025-10-08"; m13._patchedOnce = true; }
  }
  ensureJoinDates();

  // åŒ…è£åŸ buildTableï¼šæ¸²æŸ“æ™‚æ¨™è¨˜åŠ å…¥æ—¥å‰çš„æ¬„ä½ç‚º prejoinï¼ˆä¸å¯ç·¨è¼¯ï¼‰
  var _buildTable_j = window.buildTable;
  window.buildTable = function(){
    if (typeof _buildTable_j === 'function') _buildTable_j();
    try {
      // åŠ ä¸Šæ–°å¾½ç« ï¼šå¾ŒåŠ å…¥é¡¯ç¤ºã€Œæ–°ã€
      [...document.querySelectorAll('#tbody tr')].forEach(function(tr,ri){
        var j = new Date(MEMBERS[ri].joinDate || DATE_KEYS[0]);
        var earliest = new Date(DATE_KEYS[0]);
        var nameCell = tr.querySelectorAll('td')[1];
        if (nameCell){
          var b = nameCell.querySelector('.name-badge');
          if (b) b.remove();
          if (j > earliest){
            var badge = document.createElement('span'); badge.className='name-badge'; badge.textContent='æ–°';
            nameCell.appendChild(badge);
          }
        }
        // æ¯æ ¼è™•ç† prejoin
        DATE_KEYS.forEach(function(k,di){
          var dateObj = new Date(k);
          var cell = tr.querySelectorAll('td')[3+di];
          if (!cell) return;
          if (dateObj < j){
            cell.classList.add('prejoin');
            var st = cell.querySelector('.status');
            var gi = cell.querySelector('.guest-input');
            var pb = cell.querySelector('.pair-btn');
            var pill = cell.querySelector('.o2o-pill');
            if (st){ st.textContent = ''; st.setAttribute('aria-label',''); }
            if (gi){ gi.value = '0'; }
            if (pb){ pb.dataset.partners = '[]'; }
            if (pill){ pill.dataset.count='0'; pill.textContent='ğŸ¤ 0'; }
          }else{
            cell.classList.remove('prejoin');
          }
        });
      });
    }catch(e){}
  };

  // snapshot èˆ‡ applyRows ç¶­æŒåŸç‹€ï¼›çµ±è¨ˆèˆ‡çŸ©é™£éœ€ä»¥åŠ å…¥æ—¥ç‚ºé–€æª»
  var _fillRightSummary = window.fillRightSummary;
  window.fillRightSummary = function(tr,ri){
  var cells=tr.querySelectorAll('td'); var present=0, guestCnt=0, guestDays=0, o2oSum=0, o2oDays=0;
  var j = new Date(MEMBERS[ri].joinDate || DATE_KEYS[0]);
  DATE_KEYS.forEach(function(k,di){
    var d = new Date(k);
    if (d < j) return; // æœªåŠ å…¥å‰ä¸è¨ˆ
    var cell=cells[3+di]; var v=cell.querySelector('.status').textContent;
    if(v==='ğŸŸ¢'||v==='ğŸŸ¡'){ present++; }
    var g=parseInt(cell.querySelector('.guest-input')?.value||'0')||0; guestCnt+=g; if(g>0 && (v==='ğŸŸ¢'||v==='ğŸŸ¡')) guestDays++;
    var partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]'); if((v==='ğŸŸ¢'||v==='ğŸŸ¡') && partners.length>0) o2oDays++; o2oSum+=partners.length;
  });
  // åŸºæœŸï¼ˆtenureï¼‰èª¿æ•´ï¼šåªè¨ˆç®—åŠ å…¥æ—¥ä¹‹å¾Œä¸”ä¸æ™šæ–¼ä»Šå¤©çš„æ‡‰åƒèˆ‡å ´æ¬¡
  var totalAll = DATE_KEYS.filter(function(k){ return (new Date(k) >= j); }).length;
  var today = new Date();
  var tenureEligible = DATE_KEYS.filter(function(k){ var d=new Date(k); return (d >= j) && (d <= today); }).length;
  if (tenureEligible < 1) tenureEligible = 1; // é¿å…é™¤ä»¥é›¶
  var attRate= totalAll? Math.round((present/totalAll)*1000)/10 : 0;
  var guestRate= present? Math.round((guestDays/present)*1000)/10 : 0;
  var o2oRate= present? Math.round((o2oDays/present)*1000)/10 : 0;
  var baseScore = (0.5*attRate + 0.25*guestRate + 0.25*o2oRate);
  // æ–°äººæŠ‘åˆ¶ï¼ˆå…¬å¹³åŸºæœŸï¼‰ï¼šå‰ 4 å ´å…§æŒ‰æ¯”ä¾‹éå¢æ¬Šé‡ï¼Œæ»¿ 4 å ´å³é” 100%
  var tenureFactor = Math.min(1, tenureEligible / 4);
  var perf = Math.round(baseScore * tenureFactor * 10)/10;
  var base=3+DATE_KEYS.length;
  var vals=[attRate.toFixed(1)+'%', guestCnt, guestRate.toFixed(1)+'%', o2oSum, o2oRate.toFixed(1)+'%', perf.toFixed(1)+'%'];
  for(let i=0;i<6;i++){
    var td=tr.querySelectorAll('td')[base+i];
    td.textContent=vals[i];
    td.className=['att-rate','guest-sum','guest-rate','o2o-sum','o2o-rate','perf-score'][i];
  }
};

  var _updateTotals = window.updateTotals;
  window.updateTotals = function(){
    DATE_KEYS.forEach(function(k,di){
      var g=0,y=0,r=0,guestSum=0;
      var seen=new Set();
      [...tbody.querySelectorAll('tr')].forEach(function(tr,ri){
        var join = new Date(MEMBERS[ri].joinDate || DATE_KEYS[0]);
        var d = new Date(k);
        if (d < join) return; // æœªåŠ å…¥ä¸ç´å…¥ç•¶æ—¥çµ±è¨ˆ
        var cell=tr.querySelectorAll('td')[3+di];
        var v=cell.querySelector('.status').textContent;
        if(v==='ğŸŸ¢') g++; else if(v==='ğŸŸ¡') y++; else if(v==='ğŸ”´') r++;
        guestSum += parseInt(cell.querySelector('.guest-input')?.value||'0')||0;
        var partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]');
        partners.forEach(function(pj){
          // å¦ä¸€ä½ä¹Ÿå¿…é ˆå·²åŠ å…¥
          var joinB = new Date(MEMBERS[pj].joinDate || DATE_KEYS[0]);
          if (d < joinB) return;
          var a=Math.min(ri,pj), b=Math.max(ri,pj);
          seen.add(a+'-'+b);
        });
      });
      var o2o = seen.size;
      var wrap=document.querySelector('.totals[data-date="'+k+'"]');
      wrap.innerHTML='<span>ğŸŸ¢ '+g+'</span> <span>ğŸŸ¡ '+y+'</span> <span>ğŸ”´ '+r+'</span> <span>ğŸ‘¥ '+guestSum+'</span> <span>ğŸ¤ '+o2o+'</span>';
    });
    [...tbody.querySelectorAll('tr')].forEach(function(tr,ri){ window.fillRightSummary(tr,ri); });
    window.buildMatrix();
  };

  var _buildMatrix = window.buildMatrix;
  window.buildMatrix = function(){
    var tbl=document.getElementById('matrix'); if(!tbl) return;
    var details = Array.from({length:MEMBERS.length},()=>Array(MEMBERS.length).fill(null).map(()=>new Set()));
    DATE_KEYS.forEach(function(k,di){
      var d = new Date(k);
      var seenDay = new Set();
      [...tbody.querySelectorAll('tr')].forEach(function(tr,ri){
        var joinA = new Date(MEMBERS[ri].joinDate || DATE_KEYS[0]);
        if (d < joinA) return;
        var cell=tr.querySelectorAll('td')[3+di];
        var partners = JSON.parse(cell.querySelector('.pair-btn')?.dataset.partners||'[]');
        partners.forEach(function(pj){
          var joinB = new Date(MEMBERS[pj].joinDate || DATE_KEYS[0]);
          if (d < joinB) return;
          var a=Math.min(ri,pj), b=Math.max(ri,pj);
          var key=a+'-'+b;
          if(!seenDay.has(key)){ seenDay.add(key); details[a][b].add(DATES[di]); details[b][a].add(DATES[di]); }
        });
      });
    });
    var html='<thead><tr><th>æˆå“¡</th>';
    MEMBERS.forEach(function(m){ html+='<th>'+m.name+'</th>'; });
    html+='</tr></thead><tbody>';
    MEMBERS.forEach(function(m,i){
      html+='<tr><th>'+m.name+'</th>';
      MEMBERS.forEach(function(n,j){
        if(i===j){ html+='<td class="diag"></td>'; }
        else{
          var cnt = details[i][j].size;
          var cls = cnt>0 ? ' class="lit"' : '';
          var tip = cnt>0 ? ' title="'+Array.from(details[i][j]).join('ã€')+'"' : '';
          html+='<td'+cls+tip+'>'+(cnt||'')+'</td>';
        }
      });
      html+='</tr>';
    });
    html+='</tbody>';
    tbl.innerHTML=html;
  };

  // === åŠ å…¥æ—¥è¨­å®š UI ===
  var joinBtn = document.getElementById('joinBtn');
  var joinDlg = document.getElementById('joinDialog');
  var joinList = document.getElementById('joinList');
  var joinOK = document.getElementById('joinOK');

  function openJoinDialog(){
    if(READ_ONLY){ alert('ğŸ”’ ç›®å‰ç‚ºè®€å–æ¨¡å¼ï¼Œè«‹å…ˆè§£é–'); return; }
    // å»ºç«‹æ¯å€‹æˆå“¡ä¸€åˆ—ï¼Œä¸‹æ‹‰å¯é¸æ—¥æœŸï¼ˆå¾ DATES æ¸…å–®ï¼‰ï¼Œé è¨­ç‚ºæˆå“¡çš„ joinDate
    joinList.innerHTML='';
    MEMBERS.forEach(function(m, idx){
      var row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='40px 1fr 180px'; row.style.gap='8px'; row.style.alignItems='center'; row.style.padding='6px 4px';
      var id=document.createElement('div'); id.textContent=String(m.id);
      var nm=document.createElement('div'); nm.textContent=m.name+'ï½œ'+m.profession;
      var sel=document.createElement('select');
      DATE_KEYS.forEach(function(k,i){
        var opt=document.createElement('option'); opt.value=k; opt.textContent=DATES[i]+'ï¼ˆ'+k+'ï¼‰'; sel.appendChild(opt);
      });
      sel.value = m.joinDate || DATE_KEYS[0];
      row.append(id,nm,sel);
      row.dataset.index = String(idx);
      joinList.appendChild(row);
    });
    joinDlg.showModal();
  }
  function saveJoinDates(){
    [...joinList.children].forEach(function(row){
      var idx = parseInt(row.dataset.index); var sel = row.querySelector('select');
      var val = sel.value;
      MEMBERS[idx].joinDate = val;
    });
    localStorage.setItem(MEMBERS_KEY, JSON.stringify(MEMBERS)); // è¨˜ä½
    buildTable(); // é‡æ–°æ¸²æŸ“èˆ‡çµ±è¨ˆ
    updateTotals();
  }

  if (joinBtn){ joinBtn.addEventListener('click', openJoinDialog); }
  if (joinOK){ joinOK.addEventListener('click', saveJoinDates); }

  // æ›¿æ›é›²ç«¯å„²å­˜/è®€å–ä»¥ç´å…¥ joinDate
  var _saveCloud = window.saveToFirestore;
  var _loadCloud = window.loadFromFirestore;
  window.saveToFirestore = async function(){
    if(READ_ONLY){ alert('ğŸ”’ ç›®å‰ç‚ºè®€å–æ¨¡å¼ï¼Œè«‹å…ˆè§£é–'); return; }
    const rows = snapshot();
    const data = { rows, members: MEMBERS, dateKeys: DATE_KEYS, updatedAt: new Date().toISOString() };
    // å‘¼å«åŸæœ¬çš„ Firestore å¯«æ³•ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå¦å‰‡ç›´æ¥å¯«
    if (typeof _saveCloud === 'function'){ try{ await _saveCloud(); return; }catch(e){} }
    try{
      const db = firebase.firestore();
      const docRef = db.collection('trafficSnapshots').doc('core-team-traffic-v3');
      await docRef.set(data);
      alert('âœ… å·²å¯«å…¥é›²ç«¯ï¼ˆå«åŠ å…¥æ—¥ï¼‰');
    }catch(e){ alert('âŒ é›²ç«¯å¯«å…¥å¤±æ•—ï¼š'+(e && (e.message||e))); }
  };
  window.loadFromFirestore = async function(){
    try{
      const db = firebase.firestore();
      const docRef = db.collection('trafficSnapshots').doc('core-team-traffic-v3');
      const snap = await docRef.get();
      if(!snap.exists){ alert('âš ï¸ é›²ç«¯å°šç„¡è³‡æ–™'); return; }
      const d = snap.data() || {};
      if (Array.isArray(d.members) && d.members.length){ MEMBERS = d.members; }
      ensureMember14();
      buildTable();
      if (Array.isArray(d.rows)){ applyRows(d.rows); }
      updateTotals();
      alert('âœ… å·²å¾é›²ç«¯è®€å›ï¼ˆå«åŠ å…¥æ—¥ï¼‰');
    }catch(e){ alert('âŒ é›²ç«¯è®€å–å¤±æ•—ï¼š'+(e && (e.message||e))); }
  };
})();
</script>


<script>
// === å–®ç­†æ–°å¢æˆå“¡ï¼ˆå¼·åŒ–ï¼šè‡ªå‹•ç·¨è™Ÿã€ç™½è‰²è¼¸å…¥å­—é«”ï¼‰ ===
(function(){
  function nextMemberIdSafe(){
    try{
      if (Array.isArray(window.MEMBERS) && window.MEMBERS.length){
        return window.MEMBERS.reduce((m,x)=>Math.max(m, Number(x.id)||0), 0) + 1;
      }
    }catch(e){}
    try{
      var rows = document.querySelectorAll('#tbody tr');
      if(rows && rows.length){
        var last = rows[rows.length-1];
        var idCell = last && last.querySelector('td');
        var id = idCell ? parseInt(idCell.textContent.trim(),10) : 0;
        if(!isNaN(id) && id>=0) return id + 1;
      }
    }catch(e){}
    return 1;
  }
  function wire(){
    try{
      var btn = document.getElementById('addBtn');
      var dlg = document.getElementById('addMemberDialog');
      var fId = document.getElementById('addId');
      var fName = document.getElementById('addName');
      var fProf = document.getElementById('addProf');
      var ok = document.getElementById('addOK');
      if(!btn || !dlg || !fId || !fName || !fProf || !ok) return;
      btn.addEventListener('click', function(){
        if(window.READ_ONLY){ alert('ğŸ”’ ç›®å‰ç‚ºè®€å–æ¨¡å¼ï¼Œè«‹å…ˆè§£é–'); return; }
        fId.value = String(nextMemberIdSafe());
        fName.value = '';
        fProf.value = '';
        dlg.showModal();
      });
      
      ok.addEventListener('click', function(){
        if(window.READ_ONLY) return;
        var id = Number(fId.value) || nextMemberIdSafe();
        var name = (fName.value||'').trim();
        var profession = (fProf.value||'').trim();
        if(!name || !profession){ alert('è«‹è¼¸å…¥ã€Œå§“åã€èˆ‡ã€Œå°ˆæ¥­åˆ¥ã€'); return; }
        if(!Array.isArray(window.MEMBERS)) window.MEMBERS = [];
        window.MEMBERS.push({ id:id, name:name, profession:profession, joinDate: (window.DATE_KEYS && window.DATE_KEYS[0]) });
        // ä¾ç·¨è™Ÿæ’åºï¼Œé¿å…äº‚åº
        window.MEMBERS.sort(function(a,b){ return (Number(a.id)||0) - (Number(b.id)||0); });
        try{ localStorage.setItem(window.MEMBERS_KEY, JSON.stringify(window.MEMBERS)); }catch(e){}
        // æ¸…é™¤æœå°‹ä»¥å…è¢«éš±è—
        try{
          var q = document.getElementById('q');
          if(q){ q.value = ''; }
        }catch(e){}
        if(typeof window.buildTable==='function') window.buildTable();
        if(typeof window.updateTotals==='function') window.updateTotals();
        // æ²åˆ°æœ€åº•ä¸¦é–ƒçˆæ–°åˆ—
        try{
          var rows = document.querySelectorAll('#tbody tr');
          if(rows && rows.length){
            var last = rows[rows.length-1];
            last.scrollIntoView({behavior:'smooth', block:'center'});
            last.style.transition = 'background 0.6s';
            last.style.background = '#1e293b';
            setTimeout(function(){ last.style.background = ''; }, 800);
          }
        }catch(e){}
      });

      var _setReadOnly = window.setReadOnly;
      if(typeof _setReadOnly === 'function'){
        window.setReadOnly = function(ro){
          _setReadOnly(ro);
          try{ document.getElementById('addBtn').disabled = !!ro; }catch(e){}
          try{
            var dlgEl = document.getElementById('addMemberDialog');
            if(dlgEl){ dlgEl.querySelectorAll('input').forEach(function(inp){ inp.style.color = '#e8eaed'; }); }
          }catch(e){}
        };
        try{ document.getElementById('addBtn').disabled = !!window.READ_ONLY; }catch(e){}
      }
    }catch(e){ console.error('æ–°å¢æˆå“¡ wire å¤±æ•—:', e); }
  }
  try{
    var style = document.createElement('style');
    style.textContent = '#addMemberDialog input{color:#e8eaed !important;} #addMemberDialog input::placeholder{color:#e8eaed !important; opacity:0.7;}';
    document.head.appendChild(style);
  }catch(e){}
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', wire); } else { wire(); }
})();
</script>


<script>
// === åŠ å…¥ï¼šåŠ å…¥æ—¥é¸å–® + å¼·åˆ¶è£œ #14 æ±Ÿæ˜é§¿ ===
(function(){
  function afterReady(fn){
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }
  function waitUntil(cond, cb, tries=120){
    const t = setInterval(function(){
      if (cond()){
        clearInterval(t); cb();
      } else if(--tries<=0){ clearInterval(t); }
    }, 50);
  }

  // 1) å‹•æ…‹åœ¨æ–°å¢æˆå“¡å°è©±æ¡†åŠ å…¥ã€ŒåŠ å…¥æ—¥ã€é¸å–®
  function mountJoinDateSelect(){
    try{
      var dlg = document.getElementById('addMemberDialog');
      if(!dlg || document.getElementById('addJoin')) return;
      var grid = dlg.querySelector('div[style*="grid-template-columns"]');
      if(!grid) return;
      var lab = document.createElement('label'); lab.textContent = 'åŠ å…¥æ—¥';
      var sel = document.createElement('select'); sel.id='addJoin';
      sel.style.cssText='background:#0c111c;color:#e8eaed;border:1px solid var(--border);border-radius:8px;padding:8px;';
      var keys = (window.DATE_KEYS && Array.isArray(window.DATE_KEYS)) ? window.DATE_KEYS.slice() : [];
      if(!keys.length){
        keys = ['']; // fallback
      }
      keys.forEach(function(k,i){
        var opt = document.createElement('option');
        opt.value = k || '';
        opt.textContent = k ? k : 'ï¼ˆæœ¬æœŸç¬¬ä¸€å¤©ï¼‰';
        sel.appendChild(opt);
      });
      grid.appendChild(lab);
      grid.appendChild(sel);
    }catch(e){ console.error('mountJoinDateSelect', e); }
  }

  // 2) æ”¹å¯«æ–°å¢æˆå“¡ OK è¡Œç‚ºï¼šå¸¶å…¥åŠ å…¥æ—¥ã€é‡å»ºçŸ©é™£
  function enhanceAddHandler(){
    try{
      var ok = document.getElementById('addOK');
      if(!ok) return;
      var attached = ok.getAttribute('data-enhanced');
      if(attached==='1') return;
      ok.setAttribute('data-enhanced','1');

      var fId = document.getElementById('addId');
      var fName = document.getElementById('addName');
      var fProf = document.getElementById('addProf');

      ok.addEventListener('click', function(){
        if(window.READ_ONLY) return;
        var id = Number(fId.value) || 1;
        // è‡ªå‹•ç·¨è™Ÿï¼ˆå†ä¿éšªï¼‰
        try{
          if (Array.isArray(window.MEMBERS) && window.MEMBERS.length){
            id = Math.max.apply(null, window.MEMBERS.map(function(m){ return Number(m.id)||0; })) + 1;
          }else{
            var rows = document.querySelectorAll('#tbody tr');
            if(rows && rows.length){
              var last = rows[rows.length-1];
              var idCell = last && last.querySelector('td');
              var idTmp = idCell ? parseInt(idCell.textContent.trim(),10) : 0;
              if(!isNaN(idTmp)) id = idTmp + 1;
            }
          }
        }catch(e){}

        var name = (fName && fName.value || '').trim();
        var profession = (fProf && fProf.value || '').trim();
        var joinSel = document.getElementById('addJoin');
        var joinDate = (joinSel && joinSel.value) || (window.DATE_KEYS && window.DATE_KEYS[0]) || '';

        if(!name || !profession){
          alert('è«‹è¼¸å…¥ã€Œå§“åã€èˆ‡ã€Œå°ˆæ¥­åˆ¥ã€');
          return;
        }
        if(!Array.isArray(window.MEMBERS)) window.MEMBERS = [];
        if(window.MEMBERS.some(function(m){ return String(m.name)===name; })){
          alert('æ­¤å§“åå·²å­˜åœ¨ï¼Œè«‹ç¢ºèªï¼');
          return;
        }
        window.MEMBERS.push({ id:id, name:name, profession:profession, joinDate:joinDate });
        window.MEMBERS.sort(function(a,b){ return (Number(a.id)||0)-(Number(b.id)||0); });
        try{ localStorage.setItem(window.MEMBERS_KEY, JSON.stringify(window.MEMBERS)); }catch(e){}

        try{ var q=document.getElementById('q'); if(q){ q.value=''; q.dispatchEvent(new Event('input')); } }catch(e){}
        if (typeof buildTable==='function') buildTable();
        if (typeof buildMatrix==='function') buildMatrix();
        if (typeof updateTotals==='function') updateTotals();
        setTimeout(function(){
          if (typeof updateTotals==='function') updateTotals();
          try{
            var rows = document.querySelectorAll('#tbody tr');
            if(rows && rows.length){
              var last = rows[rows.length-1];
              last.scrollIntoView({behavior:'smooth', block:'center'});
              last.style.transition='background 0.6s'; last.style.background='#1e293b';
              setTimeout(function(){ last.style.background=''; }, 800);
            }
          }catch(e){}
        },60);
      });
    }catch(e){ console.error('enhanceAddHandler', e); }
  }

  // 3) ä¸€æ¬¡æ€§å¼·åˆ¶è£œå…¥ #14 æ±Ÿæ˜é§¿ï¼ˆä½ äº¤ä»£çš„é‚£ä½ï¼‰
  function forceInsertMember(){
    try{
      if(!Array.isArray(window.MEMBERS)) window.MEMBERS = [];
      var exists = window.MEMBERS.some(function(m){ return Number(m.id)===14 || String(m.name)==='æ±Ÿæ˜é§¿'; });
      if(!exists){
        var joinDate = (window.DATE_KEYS && window.DATE_KEYS[0]) || '';
        window.MEMBERS.push({ id:14, name:'æ±Ÿæ˜é§¿', profession:'é«˜ç©ºæ¨¹æœ¨å·¥ç¨‹', joinDate:joinDate });
        window.MEMBERS.sort(function(a,b){ return (Number(a.id)||0)-(Number(b.id)||0); });
        try{ localStorage.setItem(window.MEMBERS_KEY, JSON.stringify(window.MEMBERS)); }catch(e){}
      }
      if (typeof buildTable==='function') buildTable();
      if (typeof buildMatrix==='function') buildMatrix();
      if (typeof updateTotals==='function') updateTotals();
    }catch(e){ console.error('forceInsertMember', e); }
  }

  afterReady(function(){
    // ç­‰å¾…åŸæœ¬ç¨‹å¼åˆå§‹åŒ–å®Œæˆï¼ˆbuildTable ç­‰å‡½å¼å­˜åœ¨å¾Œï¼‰
    waitUntil(function(){ return typeof buildTable==='function' && typeof buildMatrix==='function'; }, function(){
      try{ mountJoinDateSelect(); }catch(e){}
      try{ enhanceAddHandler(); }catch(e){}
      try{ forceInsertMember(); }catch(e){}
    });
  });
})();
</script>

</body>
</html>
